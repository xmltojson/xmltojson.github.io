<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Piano</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='10' fill='%231a1a2e'/><rect x='10' y='20' width='12' height='60' rx='2' fill='white'/><rect x='24' y='20' width='12' height='60' rx='2' fill='white'/><rect x='38' y='20' width='12' height='60' rx='2' fill='white'/><rect x='52' y='20' width='12' height='60' rx='2' fill='white'/><rect x='66' y='20' width='12' height='60' rx='2' fill='white'/><rect x='80' y='20' width='10' height='60' rx='2' fill='white'/><rect x='18' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='32' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='60' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='74' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/></svg>">
    
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a1a2e; --secondary: #16213e; --accent: #e94560; --gold: #ffd700; --text: #eee; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh; color: var(--text); overflow-x: hidden;
        }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; padding: 8px; }
        header { text-align: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 10px; }
        header h1 {
            font-size: clamp(1.3rem, 4vw, 2.2rem);
            background: linear-gradient(45deg, var(--gold), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        .controls-panel {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center;
            padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 10px;
        }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .control-group label { font-size: 0.7rem; color: #aaa; display: none; }
        .control-group.show-label label { display: block; }
        
        button {
            padding: 10px 16px; border: none; border-radius: 20px; cursor: pointer;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s ease;
            background: linear-gradient(145deg, #2d2d4a, #1a1a2e);
            color: var(--text); box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; gap: 6px;
            min-width: 44px; min-height: 44px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(233,69,96,0.3); }
        button:active { transform: translateY(0); }
        button.active { background: linear-gradient(145deg, var(--accent), #c73e54); }
        button.recording { animation: pulse 1s infinite; }
        button.play-all-active { background: linear-gradient(145deg, #4caf50, #388e3c); }
        button .btn-text { display: inline; }
        button .btn-icon { font-size: 1.1rem; }
        
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(233,69,96,0.7); } 50% { box-shadow: 0 0 0 8px rgba(233,69,96,0); } }
        
        select {
            padding: 10px 12px; border: none; border-radius: 15px;
            background: rgba(255,255,255,0.1); color: var(--text); cursor: pointer;
            font-size: 0.85rem; min-height: 44px;
        }
        select option { background: var(--primary); color: var(--text); }
        
        input[type="range"] { 
            width: 80px; -webkit-appearance: none; height: 6px; 
            background: rgba(255,255,255,0.2); border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: var(--accent); cursor: pointer;
        }
        
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        
        .piano-container { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            padding: 15px 0; overflow-x: auto; overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .piano {
            display: flex; position: relative;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 15px 12px 12px; border-radius: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.1);
        }
        .key { position: relative; cursor: pointer; transition: all 0.08s ease; user-select: none; -webkit-tap-highlight-color: transparent; }
        .white-key {
            width: clamp(32px, 6vw, 50px); height: clamp(140px, 22vh, 200px);
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
            border: 1px solid #ccc; border-radius: 0 0 5px 5px; margin: 0 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -4px 8px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px;
        }
        .white-key:hover { background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%); }
        .white-key.active { background: linear-gradient(180deg, #ddd 0%, #ccc 100%); transform: translateY(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .black-key {
            position: absolute; width: clamp(22px, 4vw, 32px); height: clamp(85px, 14vh, 130px);
            background: linear-gradient(180deg, #3a3a3a 0%, #1a1a1a 100%);
            border-radius: 0 0 4px 4px; z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 -3px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 6px;
        }
        .black-key:hover { background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%); }
        .black-key.active { background: linear-gradient(180deg, #2a2a2a 0%, #0a0a0a 100%); transform: translateY(2px); }
        .key-label { font-size: clamp(7px, 1.2vw, 11px); color: #888; pointer-events: none; }
        .black-key .key-label { color: #555; font-size: clamp(6px, 1vw, 9px); }
        
        .display-panel { background: rgba(0,0,0,0.4); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .display-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .now-playing { font-size: 0.9rem; color: var(--gold); flex: 1; min-width: 150px; }
        .playlist-info { font-size: 0.75rem; color: #aaa; }
        .recording-indicator { display: none; align-items: center; gap: 5px; color: var(--accent); font-weight: bold; font-size: 0.85rem; }
        .recording-indicator.active { display: flex; }
        .recording-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold)); width: 0%; transition: width 0.1s linear; }
        
        .compositions-panel { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .compositions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .compositions-header h3 { color: var(--gold); font-size: 1rem; }
        .header-controls { display: flex; gap: 6px; align-items: center; }
        .tabs { display: flex; gap: 4px; }
        .tab-btn { padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 15px; font-size: 0.8rem; min-height: 36px; }
        .tab-btn.active { background: rgba(233,69,96,0.3); color: var(--accent); }
        .compositions-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 4px; }
        .composition-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .composition-item:hover { background: rgba(255,255,255,0.1); transform: translateX(3px); }
        .composition-item.user-composition { border-left: 3px solid var(--gold); }
        .composition-item.now-playing-item { background: rgba(233,69,96,0.2); border-left: 3px solid var(--accent); }
        .composition-item.now-playing-item::before { content: "‚ñ∂"; position: absolute; left: -8px; color: var(--accent); font-size: 0.7rem; }
        .composition-number { font-size: 0.7rem; color: #666; min-width: 20px; }
        .composition-icon { font-size: 1.3rem; }
        .composition-info { flex: 1; overflow: hidden; }
        .composition-title { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .composition-meta { font-size: 0.7rem; color: #888; }
        .composition-actions { display: flex; gap: 4px; }
        .composition-actions button { padding: 6px 10px; font-size: 0.75rem; min-width: 36px; min-height: 36px; }
        
        .visualizer { height: 50px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 10px; overflow: hidden; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 5px; }
        .visualizer-bar { width: 3px; background: linear-gradient(180deg, var(--accent), var(--gold)); border-radius: 2px; transition: height 0.1s ease; }
        
        .keyboard-help { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .keyboard-help h4 { color: var(--gold); margin-bottom: 8px; font-size: 0.85rem; }
        .keyboard-shortcuts { display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.7rem; }
        .shortcut-item { display: flex; align-items: center; gap: 3px; background: rgba(255,255,255,0.05); padding: 3px 6px; border-radius: 4px; }
        .shortcut-key { padding: 2px 5px; background: rgba(255,255,255,0.15); border-radius: 3px; font-family: monospace; font-weight: bold; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--secondary); border-radius: 15px; padding: 20px; max-width: 400px; width: 100%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { color: var(--gold); font-size: 1.1rem; }
        .close-btn { background: none; font-size: 1.3rem; padding: 5px 10px; min-width: auto; min-height: auto; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; color: #aaa; font-size: 0.85rem; }
        .form-group input { width: 100%; padding: 10px 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: var(--text); font-size: 0.9rem; }
        .form-group input:focus { outline: 2px solid var(--accent); }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-input-label { display: block; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; cursor: pointer; border: 2px dashed rgba(255,255,255,0.3); font-size: 0.85rem; }
        .file-input-label:hover { border-color: var(--accent); background: rgba(233,69,96,0.1); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
        
        .toast-container { position: fixed; bottom: 15px; right: 15px; z-index: 1001; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 10px 16px; background: rgba(0,0,0,0.9); border-radius: 8px; color: white; font-size: 0.85rem; animation: slideIn 0.3s ease; border-left: 3px solid var(--accent); max-width: 280px; }
        .toast.success { border-left-color: #4caf50; }
        .toast.error { border-left-color: #f44336; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .octave-indicator { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 4px; }
        .octave-btn { width: 32px; height: 32px; padding: 0; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1rem; border-radius: 50%; }
        .octave-display { padding: 0 8px; font-size: 0.85rem; font-weight: bold; color: var(--gold); min-width: 30px; text-align: center; }
        
        @media (max-width: 600px) {
            .app-container { padding: 6px; }
            header { padding: 10px; margin-bottom: 8px; }
            .controls-panel { padding: 10px; gap: 6px; }
            button { padding: 8px 12px; font-size: 0.8rem; min-width: 40px; min-height: 40px; }
            button .btn-text { display: none; }
            button .btn-icon { font-size: 1.2rem; }
            select { padding: 8px 10px; font-size: 0.8rem; min-width: 100px; }
            input[type="range"] { width: 60px; }
            .display-panel { padding: 10px; }
            .now-playing { font-size: 0.8rem; }
            .compositions-panel { padding: 10px; }
            .compositions-list { grid-template-columns: 1fr; max-height: 200px; }
            .composition-item { padding: 8px 10px; }
            .composition-title { font-size: 0.8rem; }
            .keyboard-help { display: none; }
            .visualizer { height: 40px; }
            .white-key { width: 30px; height: 130px; }
            .black-key { width: 20px; height: 80px; }
            .key-label { font-size: 7px; }
            .header-controls { width: 100%; justify-content: space-between; }
        }
        
        @media (max-width: 400px) {
            .controls-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
            .control-group { grid-column: span 2; }
            .btn-group { grid-column: span 4; display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
            .btn-group button { padding: 8px; }
            select { width: 100%; }
            .tabs { width: 100%; }
            .tab-btn { flex: 1; text-align: center; padding: 8px 6px; font-size: 0.75rem; }
            .white-key { width: 28px; height: 120px; }
            .black-key { width: 18px; height: 75px; }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .app-container { padding: 4px; }
            header { padding: 6px; margin-bottom: 4px; }
            header h1 { font-size: 1rem; }
            .controls-panel { padding: 6px; margin-bottom: 4px; }
            .display-panel { padding: 6px; margin-bottom: 4px; }
            .compositions-panel, .keyboard-help { display: none; }
            .visualizer { height: 30px; margin-bottom: 4px; }
            .piano-container { padding: 5px 0; }
            .white-key { height: 100px; }
            .black-key { height: 60px; }
            button { padding: 6px 10px; min-height: 36px; }
            select { min-height: 36px; padding: 6px 8px; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="loading-spinner"></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <header><h1>üéπ Interactive Piano</h1></header>
        
        <div class="visualizer" id="visualizer"></div>
        
        <div class="controls-panel">
            <div class="control-group show-label">
                <label>Volume</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70">
            </div>
            
            <div class="control-group">
                <div class="octave-indicator">
                    <button class="octave-btn" id="octaveDown" title="Octave Down">‚àí</button>
                    <span class="octave-display" id="octaveDisplay">4</span>
                    <button class="octave-btn" id="octaveUp" title="Octave Up">+</button>
                </div>
            </div>
            
            <div class="control-group">
                <select id="instrumentSelect" title="Instrument">
                    <option value="piano">üéπ Piano</option>
                    <option value="electric">‚ö° Electric</option>
                    <option value="organ">üéµ Organ</option>
                    <option value="synth">üéõÔ∏è Synth</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button id="recordBtn" title="Record">
                    <span class="btn-icon">‚è∫</span>
                    <span class="btn-text">Record</span>
                </button>
                <button id="playBtn" title="Play">
                    <span class="btn-icon">‚ñ∂</span>
                    <span class="btn-text">Play</span>
                </button>
                <button id="stopBtn" title="Stop">
                    <span class="btn-icon">‚èπ</span>
                    <span class="btn-text">Stop</span>
                </button>
                <button id="saveBtn" title="Save">
                    <span class="btn-icon">üíæ</span>
                    <span class="btn-text">Save</span>
                </button>
                <button id="uploadBtn" title="Upload">
                    <span class="btn-icon">üì§</span>
                    <span class="btn-text">Upload</span>
                </button>
                <button id="downloadBtn" title="Download">
                    <span class="btn-icon">üì•</span>
                    <span class="btn-text">Download</span>
                </button>
            </div>
        </div>
        
        <div class="display-panel">
            <div class="display-header">
                <span class="now-playing" id="nowPlaying">üéµ Ready to play</span>
                <span class="playlist-info" id="playlistInfo"></span>
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>REC</span>
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
        
        <div class="keyboard-help">
            <h4>‚å®Ô∏è Keyboard</h4>
            <div class="keyboard-shortcuts">
                <div class="shortcut-item"><span class="shortcut-key">A</span>C</div>
                <div class="shortcut-item"><span class="shortcut-key">W</span>C#</div>
                <div class="shortcut-item"><span class="shortcut-key">S</span>D</div>
                <div class="shortcut-item"><span class="shortcut-key">E</span>D#</div>
                <div class="shortcut-item"><span class="shortcut-key">D</span>E</div>
                <div class="shortcut-item"><span class="shortcut-key">F</span>F</div>
                <div class="shortcut-item"><span class="shortcut-key">T</span>F#</div>
                <div class="shortcut-item"><span class="shortcut-key">G</span>G</div>
                <div class="shortcut-item"><span class="shortcut-key">Y</span>G#</div>
                <div class="shortcut-item"><span class="shortcut-key">H</span>A</div>
                <div class="shortcut-item"><span class="shortcut-key">U</span>A#</div>
                <div class="shortcut-item"><span class="shortcut-key">J</span>B</div>
            </div>
        </div>
        
        <div class="piano-container"><div class="piano" id="piano"></div></div>
        
        <div class="compositions-panel">
            <div class="compositions-header">
                <h3>üéµ Library</h3>
                <div class="header-controls">
                    <button id="playAllBtn" title="Play All">
                        <span class="btn-icon">üîÅ</span>
                        <span class="btn-text">Play All</span>
                    </button>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="preinstalled">Classics</button>
                        <button class="tab-btn" data-tab="myrecordings">My Songs</button>
                    </div>
                </div>
            </div>
            <div class="tab-content active" id="preinstalled">
                <div class="compositions-list" id="preinstalledList"></div>
            </div>
            <div class="tab-content" id="myrecordings">
                <div class="compositions-list" id="myRecordingsList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ Save Recording</h2>
                <button class="close-btn" onclick="closeSaveModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Song Name</label>
                <input type="text" id="compositionName" placeholder="Enter name...">
            </div>
            <button onclick="saveRecording()" style="width:100%;">
                <span class="btn-icon">üíæ</span>
                <span class="btn-text">Save</span>
            </button>
        </div>
    </div>

    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Upload Song</h2>
                <button class="close-btn" onclick="closeUploadModal()">√ó</button>
            </div>
            <div class="form-group">
                <div class="file-input-wrapper">
                    <div class="file-input-label">üìÅ Tap to upload JSON file</div>
                    <input type="file" id="fileInput" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, type = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function closeSaveModal() { document.getElementById('saveModal').classList.remove('active'); }
        function closeUploadModal() { document.getElementById('uploadModal').classList.remove('active'); }

        function saveRecording() {
            const name = document.getElementById('compositionName').value.trim();
            if (!name) { showToast('Please enter a name', 'error'); return; }
            if (piano.recording.length === 0) { showToast('No recording to save', 'error'); return; }
            const composition = { id: Date.now(), name, notes: piano.recording, duration: piano.recording[piano.recording.length - 1]?.time || 0 };
            piano.userRecordings.push(composition);
            piano.saveState();
            piano.renderCompositions();
            closeSaveModal();
            showToast('Recording saved!', 'success');
        }

        class PianoSound {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.volume = 0.7;
                this.instrument = 'piano';
                this.activeOscillators = new Map();
                this.noteFrequencies = {};
                this.initFrequencies();
            }

            initFrequencies() {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                for (let octave = 0; octave <= 8; octave++) {
                    notes.forEach((note, idx) => {
                        const key = `${note}${octave}`;
                        const halfSteps = (octave - 4) * 12 + (idx - 9);
                        this.noteFrequencies[key] = 440 * Math.pow(2, halfSteps / 12);
                    });
                }
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.gain.value = this.volume;
                    const compressor = this.audioContext.createDynamicsCompressor();
                    compressor.threshold.value = -50;
                    compressor.knee.value = 40;
                    compressor.ratio.value = 12;
                    compressor.attack.value = 0;
                    compressor.release.value = 0.25;
                    this.masterGain.connect(compressor);
                    compressor.connect(this.audioContext.destination);
                }
                if (this.audioContext.state === 'suspended') this.audioContext.resume();
            }

            setVolume(v) { this.volume = v; if (this.masterGain) this.masterGain.gain.value = v; }
            setInstrument(i) { this.instrument = i; }
            getFrequency(note, octave) { return this.noteFrequencies[`${note}${octave}`] || 440; }

            playNote(note, octave) {
                this.init();
                const key = `${note}${octave}`;
                if (this.activeOscillators.has(key)) this.stopNote(note, octave);

                const freq = this.getFrequency(note, octave);
                const now = this.audioContext.currentTime;
                const noteGain = this.audioContext.createGain();
                noteGain.connect(this.masterGain);
                const oscillators = [];

                if (this.instrument === 'piano') {
                    [1, 2, 3, 4, 5, 6, 8].forEach((h, i) => {
                        const amps = [0.4, 0.2, 0.15, 0.1, 0.08, 0.06, 0.04];
                        const osc = this.audioContext.createOscillator();
                        const oscGain = this.audioContext.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq * h, now);
                        oscGain.gain.setValueAtTime(amps[i], now);
                        osc.connect(oscGain);
                        oscGain.connect(noteGain);
                        osc.start(now);
                        oscillators.push(osc);
                    });
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.8, now + 0.01);
                    noteGain.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                    noteGain.gain.exponentialRampToValueAtTime(0.1, now + 2);
                } else if (this.instrument === 'electric') {
                    ['sine', 'triangle'].forEach((type, i) => {
                        const osc = this.audioContext.createOscillator();
                        const g = this.audioContext.createGain();
                        osc.type = type;
                        osc.frequency.setValueAtTime(freq * (i === 0 ? 1 : 2), now);
                        g.gain.setValueAtTime(i === 0 ? 0.4 : 0.15, now);
                        osc.connect(g); g.connect(noteGain);
                        osc.start(now);
                        oscillators.push(osc);
                    });
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.7, now + 0.02);
                    noteGain.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                } else if (this.instrument === 'organ') {
                    [0.5, 1, 2, 3, 4, 6, 8].forEach((h, i) => {
                        const amps = [0.3, 0.5, 0.4, 0.3, 0.2, 0.15, 0.1];
                        const osc = this.audioContext.createOscillator();
                        const oscGain = this.audioContext.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq * h, now);
                        oscGain.gain.setValueAtTime(amps[i], now);
                        osc.connect(oscGain);
                        oscGain.connect(noteGain);
                        osc.start(now);
                        oscillators.push(osc);
                    });
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.5, now + 0.05);
                } else if (this.instrument === 'synth') {
                    const osc1 = this.audioContext.createOscillator();
                    const osc2 = this.audioContext.createOscillator();
                    osc1.type = 'sawtooth'; osc2.type = 'square';
                    osc1.frequency.setValueAtTime(freq, now);
                    osc2.frequency.setValueAtTime(freq * 1.005, now);
                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(freq * 8, now);
                    filter.frequency.exponentialRampToValueAtTime(freq * 2, now + 0.5);
                    filter.Q.setValueAtTime(5, now);
                    const g1 = this.audioContext.createGain();
                    const g2 = this.audioContext.createGain();
                    g1.gain.setValueAtTime(0.25, now);
                    g2.gain.setValueAtTime(0.15, now);
                    osc1.connect(g1); osc2.connect(g2);
                    g1.connect(filter); g2.connect(filter);
                    filter.connect(noteGain);
                    osc1.start(now); osc2.start(now);
                    oscillators.push(osc1, osc2);
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.6, now + 0.03);
                    noteGain.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                }

                this.activeOscillators.set(key, { oscillators, noteGain });
                this.updateVisualizer(freq);
            }

            stopNote(note, octave) {
                const key = `${note}${octave}`;
                const active = this.activeOscillators.get(key);
                if (active) {
                    const { oscillators, noteGain } = active;
                    const now = this.audioContext.currentTime;
                    const release = this.instrument === 'organ' ? 0.1 : 0.3;
                    noteGain.gain.cancelScheduledValues(now);
                    noteGain.gain.setValueAtTime(noteGain.gain.value, now);
                    noteGain.gain.exponentialRampToValueAtTime(0.001, now + release);
                    oscillators.forEach(osc => osc.stop(now + release + 0.1));
                    this.activeOscillators.delete(key);
                }
            }

            updateVisualizer(freq) {
                const bars = document.querySelectorAll('.visualizer-bar');
                const nf = Math.log2(freq / 100);
                bars.forEach((bar, i) => {
                    const h = Math.min(Math.random() * 25 + nf * 6 + 8, 45);
                    bar.style.height = `${h}px`;
                    setTimeout(() => bar.style.height = '4px', 120 + i * 8);
                });
            }
        }

        // Accurate Public Domain Melodies
        // Format: Note Octave Duration (in 16th notes at 120 BPM)
        // w=whole(16), h=half(8), q=quarter(4), e=eighth(2), s=sixteenth(1), d=dotted
        const MELODIES = {
            "F√ºr Elise - Beethoven": [
                // Main theme - accurate transcription
                "E5 2", "D#5 2", "E5 2", "D#5 2", "E5 2", "B4 2", "D5 2", "C5 2",
                "A4 4", "r 2", "C4 2", "E4 2", "A4 2", "B4 4", "r 2", "E4 2",
                "G#4 2", "B4 2", "C5 4", "r 2", "E4 2", "E5 2", "D#5 2", "E5 2",
                "D#5 2", "E5 2", "B4 2", "D5 2", "C5 2", "A4 4", "r 2", "C4 2",
                "E4 2", "A4 2", "B4 4", "r 2", "E4 2", "C5 2", "B4 2", "A4 8"
            ],
            "Ode to Joy - Beethoven": [
                // Symphony No. 9 theme
                "E4 4", "E4 4", "F4 4", "G4 4", "G4 4", "F4 4", "E4 4", "D4 4",
                "C4 4", "C4 4", "D4 4", "E4 4", "E4 6", "D4 2", "D4 8",
                "E4 4", "E4 4", "F4 4", "G4 4", "G4 4", "F4 4", "E4 4", "D4 4",
                "C4 4", "C4 4", "D4 4", "E4 4", "D4 6", "C4 2", "C4 8",
                "D4 4", "D4 4", "E4 4", "C4 4", "D4 4", "E4 2", "F4 2", "E4 4", "C4 4",
                "D4 4", "E4 2", "F4 2", "E4 4", "D4 4", "C4 4", "D4 4", "G3 8",
                "E4 4", "E4 4", "F4 4", "G4 4", "G4 4", "F4 4", "E4 4", "D4 4",
                "C4 4", "C4 4", "D4 4", "E4 4", "D4 6", "C4 2", "C4 8"
            ],
            "Moonlight Sonata - Beethoven": [
                // First movement triplet pattern
                "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2",
                "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2",
                "A3 2", "C#4 2", "E4 2", "A3 2", "C#4 2", "E4 2", "A3 2", "C#4 2", "E4 2", "A3 2", "C#4 2", "E4 2",
                "G#3 2", "B3 2", "E4 2", "G#3 2", "B3 2", "E4 2", "G#3 2", "B3 2", "E4 2", "G#3 2", "B3 2", "E4 2",
                "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2", "G#3 2", "C#4 2", "E4 2",
                "F#3 2", "B3 2", "D#4 2", "F#3 2", "B3 2", "D#4 2", "E3 2", "G#3 2", "E4 2", "E4 8"
            ],
            "Canon in D - Pachelbel": [
                // Main melody line
                "F#5 8", "E5 8", "D5 8", "C#5 8", "B4 8", "A4 8", "B4 8", "C#5 8",
                "D5 4", "F#4 4", "G4 4", "A4 4", "D4 4", "F#4 4", "G4 4", "A4 4",
                "B4 4", "D4 4", "E4 4", "F#4 4", "G4 4", "F#4 4", "E4 4", "D4 4",
                "E4 4", "G4 4", "F#4 4", "E4 4", "D4 4", "C#4 4", "D4 4", "E4 4",
                "F#4 4", "A4 4", "G4 4", "F#4 4", "E4 4", "D4 4", "E4 4", "F#4 4",
                "G4 4", "B4 4", "A4 4", "G4 4", "F#4 4", "E4 4", "F#4 4", "G4 4",
                "A4 8", "D5 8", "C#5 8", "D5 8"
            ],
            "Turkish March - Mozart": [
                // Rondo Alla Turca
                "B4 2", "A4 2", "G#4 2", "A4 2", "C5 4", "r 4", "D5 2", "C5 2",
                "B4 2", "C5 2", "E5 4", "r 4", "F5 2", "E5 2", "D#5 2", "E5 2",
                "B5 2", "A5 2", "G#5 2", "A5 2", "B5 2", "A5 2", "G#5 2", "A5 2", "C6 8",
                "A5 4", "C6 4", "B5 4", "A5 4", "G5 4", "A5 4", "B5 4", "A5 4",
                "G5 4", "F#5 4", "E5 8"
            ],
            "Eine Kleine Nachtmusik - Mozart": [
                // First movement opening
                "G4 4", "r 2", "D4 2", "G4 4", "r 2", "D4 2",
                "G4 2", "D4 2", "G4 2", "B4 2", "D5 4", "r 4",
                "C5 4", "r 2", "A4 2", "C5 4", "r 2", "A4 2",
                "C5 2", "A4 2", "F#4 2", "A4 2", "D4 4", "r 4",
                "G4 2", "A4 2", "B4 2", "C5 2", "D5 4", "G4 4",
                "D5 4", "G4 4", "D5 2", "E5 2", "D5 2", "C5 2", "B4 2", "A4 2", "B4 2", "C5 2",
                "D5 4", "G4 4", "G4 4"
            ],
            "Minuet in G - Bach": [
                // BWV Anh. 114
                "D5 4", "G4 2", "A4 2", "B4 2", "C5 2", "D5 4", "G4 4", "G4 4",
                "E5 4", "C5 2", "D5 2", "E5 2", "F#5 2", "G5 4", "G4 4", "G4 4",
                "C5 4", "D5 2", "C5 2", "B4 2", "A4 2", "B4 4", "C5 2", "B4 2", "A4 2", "G4 2",
                "F#4 4", "G4 2", "A4 2", "B4 2", "G4 2", "A4 8",
                "D5 4", "G4 2", "A4 2", "B4 2", "C5 2", "D5 4", "G4 4", "G4 4",
                "E5 4", "C5 2", "D5 2", "E5 2", "F#5 2", "G5 4", "G4 4", "G4 4",
                "C5 4", "D5 2", "C5 2", "B4 2", "A4 2", "B4 4", "C5 2", "B4 2", "A4 2", "G4 2",
                "A4 4", "B4 2", "A4 2", "G4 2", "F#4 2", "G4 8"
            ],
            "Prelude in C - Bach": [
                // BWV 846 - Well-Tempered Clavier
                "C4 1", "E4 1", "G4 1", "C5 1", "E5 1", "G4 1", "C5 1", "E5 1",
                "C4 1", "E4 1", "G4 1", "C5 1", "E5 1", "G4 1", "C5 1", "E5 1",
                "C4 1", "D4 1", "A4 1", "D5 1", "F5 1", "A4 1", "D5 1", "F5 1",
                "C4 1", "D4 1", "A4 1", "D5 1", "F5 1", "A4 1", "D5 1", "F5 1",
                "B3 1", "D4 1", "G4 1", "D5 1", "F5 1", "G4 1", "D5 1", "F5 1",
                "B3 1", "D4 1", "G4 1", "D5 1", "F5 1", "G4 1", "D5 1", "F5 1",
                "C4 1", "E4 1", "G4 1", "C5 1", "E5 1", "G4 1", "C5 1", "E5 1",
                "C4 1", "E4 1", "G4 1", "C5 1", "E5 1", "G4 1", "C5 1", "E5 1",
                "C4 1", "E4 1", "A4 1", "E5 1", "A5 1", "A4 1", "E5 1", "A5 1",
                "C4 1", "D4 1", "F#4 1", "A4 1", "D5 1", "F#4 1", "A4 1", "D5 1",
                "B3 1", "D4 1", "G4 1", "D5 1", "G5 1", "G4 1", "D5 1", "G5 1",
                "C4 8", "E4 8", "G4 8", "C5 16"
            ],
            "Waltz in A Minor - Chopin": [
                // B.150
                "E5 4", "D#5 2", "E5 2", "B4 4", "E5 4", "D#5 2", "E5 2", "B4 4",
                "C5 4", "A4 4", "A4 4", "r 4",
                "E5 4", "D#5 2", "E5 2", "B4 4", "E5 4", "D#5 2", "E5 2", "B4 4",
                "C5 4", "A4 4", "A4 4", "r 4",
                "E5 4", "E5 4", "F5 4", "E5 4", "D5 4", "C5 4",
                "B4 4", "A4 4", "G#4 4", "A4 4", "B4 4", "C5 4",
                "D5 4", "E5 4", "F5 4", "E5 4", "D5 4", "C5 4",
                "B4 4", "A4 4", "G#4 4", "A4 4", "B4 4", "E4 4", "A4 8"
            ],
            "Nocturne Op.9 No.2 - Chopin": [
                // Main melody
                "Bb4 8", "r 4", "G4 2", "Bb4 2", "D5 4", "F5 4",
                "Eb5 8", "r 4", "C5 2", "Eb5 2", "G5 4", "Bb5 4",
                "Ab5 4", "G5 4", "F5 4", "Eb5 4", "D5 4", "C5 4",
                "Bb4 8", "r 4", "G4 2", "Bb4 2", "D5 4", "F5 4",
                "Eb5 8", "r 4", "C5 2", "Eb5 2", "G5 4", "Bb5 4",
                "Ab5 4", "G5 4", "F5 4", "Eb5 4", "D5 4", "Eb5 4", "F5 8"
            ],
            "Spring - Vivaldi": [
                // Four Seasons - Spring, 1st movement
                "E5 4", "F#5 4", "E5 4", "D#5 4", "E5 8", "B4 8",
                "E5 4", "F#5 4", "E5 4", "D#5 4", "E5 8", "B4 8",
                "E5 2", "E5 2", "F#5 2", "F#5 2", "G#5 2", "G#5 2", "A5 2", "A5 2",
                "G#5 4", "F#5 4", "E5 8",
                "E5 4", "F#5 4", "E5 4", "D#5 4", "E5 8", "B4 8",
                "E5 4", "F#5 4", "E5 4", "D#5 4", "E5 8", "B4 8",
                "B5 4", "A5 4", "G#5 4", "F#5 4", "E5 4", "D#5 4", "E5 8"
            ],
            "Habanera - Bizet": [
                // Carmen
                "D4 4", "Eb4 4", "E4 4", "F4 4", "E4 4", "Eb4 4", "D4 4", "C#4 4", "D4 8", "r 8",
                "D4 4", "Eb4 4", "E4 4", "F4 4", "E4 4", "Eb4 4", "D4 4", "C#4 4", "D4 8", "r 8",
                "A4 4", "G4 4", "F4 4", "E4 4", "D4 4", "C#4 4", "D4 4", "E4 4", "F4 8", "r 8",
                "A4 4", "G4 4", "F4 4", "E4 4", "D4 4", "C#4 4", "D4 8", "r 8",
                "D4 4", "Eb4 4", "E4 4", "F4 4", "E4 4", "Eb4 4", "D4 4", "C#4 4", "D4 8"
            ],
            "Greensleeves": [
                // Traditional English
                "A4 4", "C5 8", "D5 4", "E5 6", "F5 2", "E5 4",
                "D5 8", "B4 4", "G4 6", "A4 2", "B4 4",
                "C5 8", "A4 4", "A4 6", "G#4 2", "A4 4",
                "B4 8", "G#4 4", "E4 8",
                "A4 4", "C5 8", "D5 4", "E5 6", "F5 2", "E5 4",
                "D5 8", "B4 4", "G4 6", "A4 2", "B4 4",
                "C5 6", "B4 2", "A4 4", "G#4 6", "F#4 2", "G#4 4", "A4 16",
                "G5 12", "G5 6", "F#5 2", "E5 4",
                "D5 8", "B4 4", "G4 6", "A4 2", "B4 4",
                "C5 8", "A4 4", "A4 6", "G#4 2", "A4 4",
                "B4 8", "G#4 4", "E4 8",
                "G5 12", "G5 6", "F#5 2", "E5 4",
                "D5 8", "B4 4", "G4 6", "A4 2", "B4 4",
                "C5 6", "B4 2", "A4 4", "G#4 6", "F#4 2", "G#4 4", "A4 16"
            ],
            "Amazing Grace": [
                // Traditional hymn
                "G3 4", "C4 8", "E4 2", "C4 2", "E4 8", "D4 4",
                "C4 8", "A3 4", "G3 8", "G3 4",
                "C4 8", "E4 2", "C4 2", "E4 8", "D4 8", "G4 8",
                "G4 4", "E4 8", "G4 2", "E4 2", "G4 2", "E4 2",
                "E4 8", "D4 4", "C4 8", "A3 4",
                "G3 8", "G3 4", "C4 8", "E4 2", "C4 2",
                "E4 8", "D4 4", "C4 16"
            ],
            "Twinkle Twinkle Little Star": [
                // Mozart variations theme
                "C4 4", "C4 4", "G4 4", "G4 4", "A4 4", "A4 4", "G4 8",
                "F4 4", "F4 4", "E4 4", "E4 4", "D4 4", "D4 4", "C4 8",
                "G4 4", "G4 4", "F4 4", "F4 4", "E4 4", "E4 4", "D4 8",
                "G4 4", "G4 4", "F4 4", "F4 4", "E4 4", "E4 4", "D4 8",
                "C4 4", "C4 4", "G4 4", "G4 4", "A4 4", "A4 4", "G4 8",
                "F4 4", "F4 4", "E4 4", "E4 4", "D4 4", "D4 4", "C4 8"
            ],
            "Happy Birthday": [
                // Traditional
                "C4 3", "C4 1", "D4 4", "C4 4", "F4 4", "E4 8",
                "C4 3", "C4 1", "D4 4", "C4 4", "G4 4", "F4 8",
                "C4 3", "C4 1", "C5 4", "A4 4", "F4 4", "E4 4", "D4 8",
                "Bb4 3", "Bb4 1", "A4 4", "F4 4", "G4 4", "F4 8"
            ],
            "Jingle Bells": [
                // Traditional Christmas
                "E4 4", "E4 4", "E4 8",
                "E4 4", "E4 4", "E4 8",
                "E4 4", "G4 4", "C4 4", "D4 4", "E4 16",
                "F4 4", "F4 4", "F4 4", "F4 4",
                "F4 4", "E4 4", "E4 4", "E4 2", "E4 2",
                "E4 4", "D4 4", "D4 4", "E4 4", "D4 8", "G4 8",
                "E4 4", "E4 4", "E4 8",
                "E4 4", "E4 4", "E4 8",
                "E4 4", "G4 4", "C4 4", "D4 4", "E4 16",
                "F4 4", "F4 4", "F4 4", "F4 4",
                "F4 4", "E4 4", "E4 4", "E4 2", "E4 2",
                "G4 4", "G4 4", "F4 4", "D4 4", "C4 16"
            ],
            "Silent Night": [
                // Gruber
                "G4 6", "A4 2", "G4 4", "E4 12",
                "G4 6", "A4 2", "G4 4", "E4 12",
                "D5 8", "D5 4", "B4 12",
                "C5 8", "C5 4", "G4 12",
                "A4 8", "A4 4", "C5 6", "B4 2", "A4 4",
                "G4 6", "A4 2", "G4 4", "E4 12",
                "A4 8", "A4 4", "C5 6", "B4 2", "A4 4",
                "G4 6", "A4 2", "G4 4", "E4 12",
                "D5 8", "D5 4", "F5 6", "D5 2", "B4 4",
                "C5 12", "E5 12",
                "C5 8", "G4 4", "E4 4", "G4 6", "F4 2", "E4 4", "C4 16"
            ],
            "Carol of the Bells": [
                // Leontovych
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "B4 2", "A#4 2", "B4 2", "G#4 2",
                "B4 2", "A#4 2", "B4 2", "G#4 2",
                "C#5 2", "B4 2", "C#5 2", "A4 2",
                "C#5 2", "B4 2", "C#5 2", "A4 2",
                "D5 2", "C#5 2", "D5 2", "B4 2",
                "D5 2", "C#5 2", "D5 2", "B4 2",
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "A4 2", "G#4 2", "A4 2", "F#4 2",
                "A4 8"
            ],
            "Scarborough Fair": [
                // Traditional English
                "A4 8", "A4 4", "E4 4", "A4 4", "B4 4",
                "C5 8", "B4 4", "A4 8",
                "G4 4", "A4 4", "E4 4", "D4 8", "A3 16",
                "A4 8", "D5 4", "D5 4", "D5 4", "C5 4",
                "B4 8", "A4 4", "B4 4", "C5 4", "B4 4", "A4 4", "G4 8",
                "A4 8", "A4 4", "G4 4", "E4 4", "G4 4",
                "A4 8", "G4 4", "E4 8", "D4 8", "A3 16"
            ],
            "Auld Lang Syne": [
                // Traditional Scottish
                "G3 4", "C4 8", "C4 4", "C4 8", "E4 4",
                "D4 8", "C4 4", "D4 8", "E4 4", "D4 8",
                "C4 8", "C4 4", "E4 8", "G4 4", "A4 16",
                "A4 4", "G4 8", "E4 4", "E4 8", "C4 4",
                "D4 8", "C4 4", "D4 4", "E4 2", "D4 2",
                "C4 8", "A3 4", "A3 4", "G3 8", "C4 16"
            ],
            "La Marseillaise": [
                // French national anthem
                "G4 4", "G4 4", "G4 4", "C5 8", "C5 4",
                "D5 8", "D5 4", "G5 4", "E5 4", "C5 4", "C5 4", "A4 4", "F5 8",
                "E5 4", "E5 4", "E5 4", "F5 4", "E5 4", "D5 4", "D5 4",
                "C5 4", "C5 4", "B4 4", "C5 4", "D5 4", "E5 8",
                "D5 4", "C5 4", "C5 4", "B4 4", "C5 4", "D5 4",
                "E5 4", "F5 4", "E5 4", "D5 4", "C5 4", "B4 4", "C5 16"
            ],
            "Danny Boy": [
                // Londonderry Air
                "C4 4", "E4 4", "G4 4", "A4 4", "G4 8", "E4 4", "D4 4",
                "C4 8", "D4 4", "E4 4", "G4 8", "E4 4", "D4 4", "C4 16",
                "C4 4", "E4 4", "G4 4", "A4 4", "G4 8", "E4 4", "D4 4",
                "C4 8", "D4 4", "E4 4", "G4 8", "E4 4", "D4 4", "C4 16",
                "A4 4", "C5 4", "D5 4", "E5 4", "D5 8", "C5 4", "A4 4",
                "G4 8", "A4 4", "C5 4", "D5 8", "C5 4", "A4 4", "G4 16",
                "C4 4", "E4 4", "G4 4", "A4 4", "G4 8", "E4 4", "D4 4",
                "C4 8", "D4 4", "E4 4", "G4 8", "E4 4", "D4 4", "C4 16"
            ],
            "Brahms Lullaby": [
                // Wiegenlied
                "G4 3", "G4 3", "Bb4 8",
                "G4 3", "G4 3", "Bb4 8",
                "G4 8", "Bb4 4", "D5 8", "C5 8",
                "A4 8", "Bb4 4", "C5 8", "Bb4 16",
                "F4 8", "G4 4", "A4 8", "Bb4 16",
                "G4 3", "G4 3", "Bb4 8",
                "G4 3", "G4 3", "Bb4 8",
                "G4 8", "Bb4 4", "D5 8", "C5 8",
                "A4 8", "Bb4 4", "C5 8", "Bb4 16",
                "D5 8", "D5 4", "C5 8", "A4 8",
                "Bb4 8", "Bb4 4", "A4 8", "F4 8",
                "G4 8", "Bb4 4", "A4 8", "G4 8",
                "F4 8", "G4 4", "A4 8", "Bb4 16"
            ],
            "Mary Had a Little Lamb": [
                // Traditional
                "E4 4", "D4 4", "C4 4", "D4 4", "E4 4", "E4 4", "E4 8",
                "D4 4", "D4 4", "D4 8", "E4 4", "G4 4", "G4 8",
                "E4 4", "D4 4", "C4 4", "D4 4", "E4 4", "E4 4", "E4 4", "E4 4",
                "D4 4", "D4 4", "E4 4", "D4 4", "C4 16"
            ],
            "London Bridge": [
                // Traditional
                "G4 4", "A4 2", "G4 2", "F4 4", "E4 4", "F4 4", "G4 8",
                "D4 4", "E4 4", "F4 8", "E4 4", "F4 4", "G4 8",
                "G4 4", "A4 2", "G4 2", "F4 4", "E4 4", "F4 4", "G4 8",
                "D4 8", "G4 4", "E4 4", "C4 16"
            ],
            "Row Row Row Your Boat": [
                // Traditional round
                "C4 6", "C4 6", "C4 4", "D4 2", "E4 8",
                "E4 4", "D4 2", "E4 4", "F4 2", "G4 16",
                "C5 2", "C5 2", "C5 2", "G4 2", "G4 2", "G4 2",
                "E4 2", "E4 2", "E4 2", "C4 2", "C4 2", "C4 2",
                "G4 4", "F4 2", "E4 4", "D4 2", "C4 16"
            ],
            "When The Saints Go Marching In": [
                // Traditional spiritual
                "C4 4", "E4 4", "F4 4", "G4 12",
                "C4 4", "E4 4", "F4 4", "G4 12",
                "C4 4", "E4 4", "F4 4", "G4 8", "E4 8", "C4 8", "E4 8", "D4 12",
                "E4 4", "E4 4", "D4 4", "C4 8", "C4 4", "E4 8", "G4 8", "G4 4", "F4 12",
                "E4 4", "F4 4", "G4 8", "E4 8", "C4 8", "D4 8", "C4 16"
            ]
        };

        function parseMelody(melodyArray) {
            const notes = [];
            let time = 0;
            const tempo = 120; // BPM
            const sixteenthNote = (60 / tempo / 4) * 1000; // Duration of 16th note in ms

            melodyArray.forEach(item => {
                const parts = item.trim().split(' ');
                if (parts.length !== 2) return;
                
                const noteStr = parts[0];
                const duration = parseInt(parts[1]) * sixteenthNote;
                
                if (noteStr === 'r') {
                    // Rest
                    time += duration;
                    return;
                }
                
                // Parse note (e.g., "C#4", "Bb5", "G3")
                let note, octave;
                if (noteStr.length === 2) {
                    note = noteStr[0];
                    octave = parseInt(noteStr[1]);
                } else if (noteStr.length === 3) {
                    if (noteStr[1] === '#') {
                        note = noteStr[0] + '#';
                        octave = parseInt(noteStr[2]);
                    } else if (noteStr[1] === 'b') {
                        // Convert flats to sharps
                        const flatToSharp = {
                            'Db': 'C#', 'Eb': 'D#', 'Fb': 'E', 'Gb': 'F#',
                            'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B'
                        };
                        const flatNote = noteStr[0] + 'b';
                        note = flatToSharp[flatNote] || noteStr[0];
                        octave = parseInt(noteStr[2]);
                    }
                }
                
                if (note && !isNaN(octave)) {
                    const noteOnTime = time;
                    const noteOffTime = time + duration - 30; // Small gap between notes
                    
                    notes.push({ type: 'noteOn', note, octave, time: noteOnTime });
                    notes.push({ type: 'noteOff', note, octave, time: noteOffTime });
                }
                
                time += duration;
            });

            return notes;
        }

        const preinstalledCompositions = Object.entries(MELODIES).map(([name, melody], idx) => {
            const notes = parseMelody(melody);
            return { 
                id: idx + 1, 
                name, 
                notes, 
                duration: notes.length > 0 ? notes[notes.length - 1].time + 200 : 0 
            };
        });

        class Piano {
            constructor() {
                this.sound = new PianoSound();
                this.octave = 4;
                this.isRecording = false;
                this.isPlaying = false;
                this.isPlayingAll = false;
                this.currentPlayingIndex = -1;
                this.recording = [];
                this.recordingStartTime = 0;
                this.currentComposition = null;
                this.playbackTimeouts = [];
                this.userRecordings = [];
                this.activeKeys = new Set();
                this.keyboardMap = { 'a':'C','w':'C#','s':'D','e':'D#','d':'E','f':'F','t':'F#','g':'G','y':'G#','h':'A','u':'A#','j':'B','k':'C+','o':'C#+','l':'D+' };
                this.init();
            }

            init() {
                this.createPiano();
                this.createVisualizer();
                this.setupEventListeners();
                this.loadState();
                this.renderCompositions();
                this.updateOctaveDisplay();
                setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
            }

            createPiano() {
                const piano = document.getElementById('piano');
                piano.innerHTML = '';
                const whiteNotes = ['C','D','E','F','G','A','B'];
                const blackNotes = ['C#','D#',null,'F#','G#','A#',null];
                const whiteLabels = ['A','S','D','F','G','H','J','K','L'];
                const blackLabels = ['W','E','','T','Y','U','','O'];
                let wi = 0, bi = 0;

                for (let o = 0; o < 2; o++) {
                    whiteNotes.forEach((note, i) => {
                        const oct = this.octave + o;
                        const key = document.createElement('div');
                        key.className = 'key white-key';
                        key.dataset.note = note;
                        key.dataset.octave = oct;
                        key.innerHTML = `<span class="key-label">${whiteLabels[wi] || ''}</span>`;
                        piano.appendChild(key);
                        wi++;

                        if (blackNotes[i]) {
                            const bkey = document.createElement('div');
                            bkey.className = 'key black-key';
                            bkey.dataset.note = blackNotes[i];
                            bkey.dataset.octave = oct;
                            bkey.innerHTML = `<span class="key-label">${blackLabels[bi] || ''}</span>`;
                            piano.appendChild(bkey);
                        }
                        bi++;
                    });
                }
                this.positionBlackKeys();
            }

            positionBlackKeys() {
                const piano = document.getElementById('piano');
                const whites = piano.querySelectorAll('.white-key');
                const blacks = piano.querySelectorAll('.black-key');
                if (!whites.length) return;
                const ww = whites[0].offsetWidth + 2;
                const bw = blacks[0]?.offsetWidth || 22;
                const pattern = [1,1,0,1,1,1,0];
                let bi = 0;
                for (let i = 0; i < whites.length && bi < blacks.length; i++) {
                    if (pattern[i % 7]) {
                        blacks[bi].style.left = `${(i + 1) * ww - bw / 2 + 11}px`;
                        bi++;
                    }
                }
            }

            createVisualizer() {
                const v = document.getElementById('visualizer');
                v.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    bar.style.height = '4px';
                    v.appendChild(bar);
                }
            }

            updateOctaveDisplay() {
                document.getElementById('octaveDisplay').textContent = this.octave;
            }

            changeOctave(delta) {
                const newOctave = this.octave + delta;
                if (newOctave >= 2 && newOctave <= 6) {
                    this.octave = newOctave;
                    this.createPiano();
                    this.updateOctaveDisplay();
                    this.saveState();
                }
            }

            setupEventListeners() {
                const piano = document.getElementById('piano');
                
                piano.addEventListener('mousedown', e => { e.preventDefault(); this.handleKeyPress(e); });
                piano.addEventListener('mouseup', e => this.handleKeyRelease(e));
                piano.addEventListener('mouseleave', () => this.releaseAllKeys());
                piano.addEventListener('mouseover', e => { if (e.buttons === 1) this.handleKeyPress(e); });
                piano.addEventListener('mouseout', e => { if (e.buttons === 1) this.handleKeyRelease(e); });

                piano.addEventListener('touchstart', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) this.playKeyByElement(key);
                    });
                }, { passive: false });

                piano.addEventListener('touchend', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) this.releaseKeyByElement(key);
                    });
                }, { passive: false });

                piano.addEventListener('touchmove', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) {
                            const keyId = `${key.dataset.note}${key.dataset.octave}`;
                            if (!this.activeKeys.has(keyId)) {
                                this.releaseAllKeys();
                                this.playKeyByElement(key);
                            }
                        }
                    });
                }, { passive: false });

                document.addEventListener('keydown', e => {
                    if (e.repeat || e.target.tagName === 'INPUT') return;
                    if (e.key === 'z' || e.key === 'Z') { this.changeOctave(-1); return; }
                    if (e.key === 'x' || e.key === 'X') { this.changeOctave(1); return; }
                    if (e.key === ' ') { e.preventDefault(); this.togglePlayAll(); return; }
                    this.handleKeyboardPress(e.key.toLowerCase());
                });
                document.addEventListener('keyup', e => {
                    if (e.target.tagName === 'INPUT') return;
                    this.handleKeyboardRelease(e.key.toLowerCase());
                });

                document.getElementById('octaveDown').addEventListener('click', () => this.changeOctave(-1));
                document.getElementById('octaveUp').addEventListener('click', () => this.changeOctave(1));

                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
                document.getElementById('playBtn').addEventListener('click', () => this.playRecording());
                document.getElementById('stopBtn').addEventListener('click', () => this.stop());
                document.getElementById('saveBtn').addEventListener('click', () => this.openSaveModal());
                document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('uploadModal').classList.add('active'));
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadRecording());
                document.getElementById('playAllBtn').addEventListener('click', () => this.togglePlayAll());

                document.getElementById('volumeSlider').addEventListener('input', e => {
                    this.sound.setVolume(e.target.value / 100);
                    this.saveState();
                });

                document.getElementById('instrumentSelect').addEventListener('change', e => {
                    this.sound.setInstrument(e.target.value);
                    this.saveState();
                });

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                    });
                });

                document.getElementById('fileInput').addEventListener('change', e => this.handleFileUpload(e));
                window.addEventListener('resize', () => this.positionBlackKeys());

                ['click', 'touchstart', 'keydown'].forEach(evt => {
                    document.addEventListener(evt, () => this.sound.init(), { once: true });
                });

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
                });
            }

            handleKeyPress(e) {
                const key = e.target.closest('.key');
                if (key) this.playKeyByElement(key);
            }

            handleKeyRelease(e) {
                const key = e.target.closest('.key');
                if (key) this.releaseKeyByElement(key);
            }

            playKeyByElement(key) {
                const note = key.dataset.note;
                const octave = parseInt(key.dataset.octave);
                const id = `${note}${octave}`;
                if (this.activeKeys.has(id)) return;
                this.activeKeys.add(id);
                this.playNote(note, octave);
                key.classList.add('active');
            }

            releaseKeyByElement(key) {
                const note = key.dataset.note;
                const octave = parseInt(key.dataset.octave);
                const id = `${note}${octave}`;
                if (!this.activeKeys.has(id)) return;
                this.activeKeys.delete(id);
                this.stopNote(note, octave);
                key.classList.remove('active');
            }

            releaseAllKeys() {
                document.querySelectorAll('.key.active').forEach(key => this.releaseKeyByElement(key));
            }

            handleKeyboardPress(k) {
                let note = this.keyboardMap[k];
                if (!note) return;
                let octave = this.octave;
                if (note.includes('+')) { note = note.replace('+', ''); octave++; }
                const id = `${note}${octave}`;
                if (this.activeKeys.has(id)) return;
                this.activeKeys.add(id);
                this.playNote(note, octave);
                this.highlightKey(note, octave, true);
            }

            handleKeyboardRelease(k) {
                let note = this.keyboardMap[k];
                if (!note) return;
                let octave = this.octave;
                if (note.includes('+')) { note = note.replace('+', ''); octave++; }
                const id = `${note}${octave}`;
                if (!this.activeKeys.has(id)) return;
                this.activeKeys.delete(id);
                this.stopNote(note, octave);
                this.highlightKey(note, octave, false);
            }

            playNote(note, octave) {
                this.sound.playNote(note, octave);
                if (this.isRecording) {
                    this.recording.push({ type: 'noteOn', note, octave, time: Date.now() - this.recordingStartTime });
                }
            }

            stopNote(note, octave) {
                this.sound.stopNote(note, octave);
                if (this.isRecording) {
                    this.recording.push({ type: 'noteOff', note, octave, time: Date.now() - this.recordingStartTime });
                }
            }

            highlightKey(note, octave, active) {
                document.querySelectorAll('.key').forEach(key => {
                    if (key.dataset.note === note && parseInt(key.dataset.octave) === octave) {
                        key.classList.toggle('active', active);
                    }
                });
            }

            toggleRecording() {
                if (this.isRecording) {
                    this.isRecording = false;
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordingIndicator').classList.remove('active');
                    document.getElementById('nowPlaying').textContent = this.recording.length ? `üéµ Recorded ${this.recording.length} events` : 'üéµ No notes recorded';
                    showToast('Recording stopped', 'success');
                } else {
                    this.stop();
                    this.recording = [];
                    this.recordingStartTime = Date.now();
                    this.isRecording = true;
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordingIndicator').classList.add('active');
                    document.getElementById('nowPlaying').textContent = 'üî¥ Recording...';
                    showToast('Recording started', 'success');
                }
            }

            playRecording() {
                if (!this.recording.length && !this.currentComposition) {
                    showToast('No recording to play', 'error');
                    return;
                }
                this.playComposition(this.currentComposition || { notes: this.recording, name: 'Your Recording' });
            }

            togglePlayAll() {
                if (this.isPlayingAll) {
                    this.stop();
                    showToast('Playlist stopped');
                } else {
                    this.isPlayingAll = true;
                    this.currentPlayingIndex = -1;
                    document.getElementById('playAllBtn').classList.add('play-all-active');
                    this.playNextInPlaylist();
                    showToast('Playing all songs');
                }
            }

            playNextInPlaylist() {
                if (!this.isPlayingAll) return;
                
                this.currentPlayingIndex++;
                if (this.currentPlayingIndex >= preinstalledCompositions.length) {
                    this.currentPlayingIndex = 0;
                }
                
                const comp = preinstalledCompositions[this.currentPlayingIndex];
                this.updatePlaylistInfo();
                this.renderCompositions();
                this.playCompositionWithCallback(comp, () => {
                    if (this.isPlayingAll) {
                        setTimeout(() => this.playNextInPlaylist(), 1500);
                    }
                });
            }

            updatePlaylistInfo() {
                const info = document.getElementById('playlistInfo');
                if (this.isPlayingAll) {
                    info.textContent = `${this.currentPlayingIndex + 1} / ${preinstalledCompositions.length}`;
                } else {
                    info.textContent = '';
                }
            }

            playComposition(comp) {
                this.playCompositionWithCallback(comp, null);
            }

            playCompositionWithCallback(comp, onComplete) {
                const wasPlayingAll = this.isPlayingAll;
                const playingIndex = this.currentPlayingIndex;
                
                this.clearPlayback();
                
                this.isPlayingAll = wasPlayingAll;
                this.currentPlayingIndex = playingIndex;
                
                this.isPlaying = true;
                this.currentComposition = comp;
                document.getElementById('playBtn').classList.add('active');
                document.getElementById('nowPlaying').textContent = `‚ñ∂ ${comp.name}`;

                const notes = comp.notes;
                if (!notes?.length) { 
                    this.clearPlayback(); 
                    if (onComplete) onComplete();
                    return; 
                }

                const totalDuration = notes[notes.length - 1]?.time || 0;
                const startTime = Date.now();

                const progressInterval = setInterval(() => {
                    if (!this.isPlaying) { clearInterval(progressInterval); return; }
                    const progress = Math.min((Date.now() - startTime) / totalDuration * 100, 100);
                    document.getElementById('progressFill').style.width = `${progress}%`;
                }, 50);
                this.playbackTimeouts.push({ clear: () => clearInterval(progressInterval) });

                notes.forEach(event => {
                    const timeout = setTimeout(() => {
                        if (!this.isPlaying) return;
                        if (event.type === 'noteOn') {
                            this.sound.playNote(event.note, event.octave);
                            this.highlightKey(event.note, event.octave, true);
                        } else {
                            this.sound.stopNote(event.note, event.octave);
                            this.highlightKey(event.note, event.octave, false);
                        }
                    }, event.time);
                    this.playbackTimeouts.push(timeout);
                });

                this.playbackTimeouts.push(setTimeout(() => {
                    this.clearPlayback();
                    if (onComplete) {
                        onComplete();
                    } else if (!this.isPlayingAll) {
                        document.getElementById('nowPlaying').textContent = 'üéµ Ready to play';
                    }
                }, totalDuration + 300));
            }

            clearPlayback() {
                this.isPlaying = false;
                this.playbackTimeouts.forEach(t => {
                    if (typeof t === 'number') clearTimeout(t);
                    else if (t?.clear) t.clear();
                });
                this.playbackTimeouts = [];
                document.getElementById('playBtn').classList.remove('active');
                document.getElementById('progressFill').style.width = '0%';
                document.querySelectorAll('.key').forEach(key => key.classList.remove('active', 'highlight'));
                this.sound.activeOscillators.forEach((_, key) => {
                    const match = key.match(/([A-G]#?)(\d)/);
                    if (match) this.sound.stopNote(match[1], parseInt(match[2]));
                });
                this.activeKeys.clear();
            }

            stop() {
                this.isPlayingAll = false;
                this.currentPlayingIndex = -1;
                document.getElementById('playAllBtn').classList.remove('play-all-active');
                this.updatePlaylistInfo();
                this.clearPlayback();
                document.getElementById('nowPlaying').textContent = 'üéµ Ready to play';
                this.renderCompositions();
            }

            openSaveModal() {
                if (!this.recording.length) { showToast('No recording to save!', 'error'); return; }
                document.getElementById('saveModal').classList.add('active');
                document.getElementById('compositionName').focus();
            }

            downloadRecording() {
                if (!this.recording.length) { showToast('No recording to download!', 'error'); return; }
                const data = { name: 'My Piano Recording', notes: this.recording, duration: this.recording[this.recording.length - 1]?.time || 0, createdAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `piano-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                showToast('Downloaded!', 'success');
            }

            handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const comp = JSON.parse(event.target.result);
                        if (comp.notes?.length) {
                            comp.id = Date.now();
                            comp.name = comp.name || file.name.replace('.json', '');
                            this.userRecordings.push(comp);
                            this.saveState();
                            this.renderCompositions();
                            closeUploadModal();
                            showToast(`Uploaded: ${comp.name}`, 'success');
                        } else { showToast('Invalid file', 'error'); }
                    } catch { showToast('Error reading file', 'error'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            }

            renderCompositions() {
                const preList = document.getElementById('preinstalledList');
                preList.innerHTML = '';
                preinstalledCompositions.forEach((comp, idx) => preList.appendChild(this.createCompItem(comp, false, idx)));

                const myList = document.getElementById('myRecordingsList');
                myList.innerHTML = '';
                if (!this.userRecordings.length) {
                    myList.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No recordings yet. Press Record to create one!</p>';
                } else {
                    this.userRecordings.forEach((comp, idx) => myList.appendChild(this.createCompItem(comp, true, idx)));
                }
            }

            createCompItem(comp, isUser, idx) {
                const item = document.createElement('div');
                const isCurrentlyPlaying = this.isPlayingAll && this.currentPlayingIndex === idx && !isUser;
                item.className = `composition-item ${isUser ? 'user-composition' : ''} ${isCurrentlyPlaying ? 'now-playing-item' : ''}`;
                const dur = Math.round((comp.duration || 0) / 1000);
                const min = Math.floor(dur / 60);
                const sec = dur % 60;
                item.innerHTML = `
                    <span class="composition-number">${idx + 1}</span>
                    <span class="composition-icon">${isUser ? 'üéµ' : 'üéº'}</span>
                    <div class="composition-info">
                        <div class="composition-title">${comp.name}</div>
                        <div class="composition-meta">${min}:${sec.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="composition-actions">
                        <button class="play-btn" title="Play">‚ñ∂</button>
                        ${isUser ? '<button class="delete-btn" title="Delete">üóë</button>' : ''}
                    </div>
                `;
                item.querySelector('.play-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    if (this.isPlayingAll) {
                        this.isPlayingAll = false;
                        document.getElementById('playAllBtn').classList.remove('play-all-active');
                        this.updatePlaylistInfo();
                    }
                    this.currentComposition = comp;
                    this.playComposition(comp);
                });
                if (isUser) {
                    item.querySelector('.delete-btn').addEventListener('click', e => {
                        e.stopPropagation();
                        if (confirm('Delete this recording?')) {
                            this.userRecordings = this.userRecordings.filter(c => c.id !== comp.id);
                            this.saveState();
                            this.renderCompositions();
                            showToast('Deleted', 'success');
                        }
                    });
                }
                return item;
            }

            saveState() {
                try {
                    localStorage.setItem('pianoState', JSON.stringify({
                        userRecordings: this.userRecordings,
                        volume: this.sound.volume,
                        octave: this.octave,
                        instrument: this.sound.instrument
                    }));
                } catch {}
            }

            loadState() {
                try {
                    const saved = localStorage.getItem('pianoState');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.userRecordings = state.userRecordings || [];
                        this.sound.setVolume(state.volume ?? 0.7);
                        this.octave = state.octave || 4;
                        this.sound.setInstrument(state.instrument || 'piano');
                        document.getElementById('volumeSlider').value = (state.volume ?? 0.7) * 100;
                        document.getElementById('instrumentSelect').value = state.instrument || 'piano';
                    }
                } catch {}
            }
        }

        let piano;
        document.addEventListener('DOMContentLoaded', () => { piano = new Piano(); });
    </script>
</body>
</html>
