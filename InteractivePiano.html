<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Piano</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='10' fill='%231a1a2e'/><rect x='10' y='20' width='12' height='60' rx='2' fill='white'/><rect x='24' y='20' width='12' height='60' rx='2' fill='white'/><rect x='38' y='20' width='12' height='60' rx='2' fill='white'/><rect x='52' y='20' width='12' height='60' rx='2' fill='white'/><rect x='66' y='20' width='12' height='60' rx='2' fill='white'/><rect x='80' y='20' width='10' height='60' rx='2' fill='white'/><rect x='18' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='32' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='60' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/><rect x='74' y='20' width='8' height='35' rx='1' fill='%231a1a2e'/></svg>">
    
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a1a2e; --secondary: #16213e; --accent: #e94560; --gold: #ffd700; --text: #eee; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; padding: 10px; }
        header { text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 15px; }
        header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            background: linear-gradient(45deg, var(--gold), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .controls-panel {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 15px;
        }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .control-group label { font-size: 0.8rem; color: #aaa; }
        button {
            padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;
            background: linear-gradient(145deg, #2d2d4a, #1a1a2e);
            color: var(--text); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(233,69,96,0.4); }
        button:active { transform: translateY(0); }
        button.active { background: linear-gradient(145deg, var(--accent), #c73e54); }
        button.recording { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(233,69,96,0.7); } 50% { box-shadow: 0 0 0 10px rgba(233,69,96,0); } }
        select, input[type="range"] {
            padding: 8px 15px; border: none; border-radius: 20px;
            background: rgba(255,255,255,0.1); color: var(--text); cursor: pointer;
        }
        select { min-width: 150px; }
        select option { background: var(--primary); color: var(--text); }
        input[type="range"] { width: 100px; -webkit-appearance: none; height: 8px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer;
        }
        .piano-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px 0; overflow-x: auto; }
        .piano {
            display: flex; position: relative;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 20px 15px 15px; border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.1);
        }
        .key { position: relative; cursor: pointer; transition: all 0.08s ease; user-select: none; -webkit-tap-highlight-color: transparent; }
        .white-key {
            width: clamp(30px, 5vw, 50px); height: clamp(150px, 25vh, 220px);
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
            border: 1px solid #ccc; border-radius: 0 0 6px 6px; margin: 0 1px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 -5px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 10px;
        }
        .white-key:hover { background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%); }
        .white-key.active { background: linear-gradient(180deg, #ddd 0%, #ccc 100%); transform: translateY(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .white-key.highlight { background: linear-gradient(180deg, var(--gold) 0%, #e6c200 100%); }
        .black-key {
            position: absolute; width: clamp(20px, 3vw, 32px); height: clamp(90px, 15vh, 140px);
            background: linear-gradient(180deg, #3a3a3a 0%, #1a1a1a 100%);
            border-radius: 0 0 4px 4px; z-index: 10;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5), inset 0 -3px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px;
        }
        .black-key:hover { background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%); }
        .black-key.active { background: linear-gradient(180deg, #2a2a2a 0%, #0a0a0a 100%); transform: translateY(2px); }
        .black-key.highlight { background: linear-gradient(180deg, var(--accent) 0%, #c73e54 100%); }
        .key-label { font-size: clamp(8px, 1.5vw, 12px); color: #888; pointer-events: none; }
        .black-key .key-label { color: #666; }
        .display-panel { background: rgba(0,0,0,0.4); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .display-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .now-playing { font-size: 1rem; color: var(--gold); }
        .recording-indicator { display: none; align-items: center; gap: 5px; color: var(--accent); font-weight: bold; }
        .recording-indicator.active { display: flex; }
        .recording-dot { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold)); width: 0%; transition: width 0.1s linear; }
        .compositions-panel { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .compositions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .compositions-header h3 { color: var(--gold); }
        .tabs { display: flex; gap: 5px; }
        .tab-btn { padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 20px; font-size: 0.85rem; }
        .tab-btn.active { background: rgba(233,69,96,0.3); color: var(--accent); }
        .compositions-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding-right: 5px; }
        .composition-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .composition-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .composition-item.user-composition { border-left: 3px solid var(--gold); }
        .composition-icon { font-size: 1.5rem; }
        .composition-info { flex: 1; overflow: hidden; }
        .composition-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .composition-duration { font-size: 0.8rem; color: #888; }
        .composition-actions { display: flex; gap: 5px; }
        .composition-actions button { padding: 5px 10px; font-size: 0.8rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--secondary); border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--gold); }
        .close-btn { background: none; font-size: 1.5rem; padding: 5px 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .form-group input { width: 100%; padding: 12px 15px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: var(--text); font-size: 1rem; }
        .form-group input:focus { outline: 2px solid var(--accent); }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-input-label { display: block; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; cursor: pointer; border: 2px dashed rgba(255,255,255,0.3); }
        .file-input-label:hover { border-color: var(--accent); background: rgba(233,69,96,0.1); }
        .visualizer { height: 60px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 15px; overflow: hidden; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 5px; }
        .visualizer-bar { width: 4px; background: linear-gradient(180deg, var(--accent), var(--gold)); border-radius: 2px; transition: height 0.1s ease; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .keyboard-help { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .keyboard-help h4 { color: var(--gold); margin-bottom: 10px; font-size: 0.9rem; }
        .keyboard-shortcuts { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75rem; }
        .shortcut-item { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 5px; }
        .shortcut-key { padding: 2px 6px; background: rgba(255,255,255,0.15); border-radius: 3px; font-family: monospace; font-weight: bold; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
        @media (max-width: 768px) {
            .controls-panel { padding: 10px; }
            .control-group { flex: 1; min-width: 80px; }
            button { padding: 8px 15px; font-size: 0.8rem; }
            .compositions-list { grid-template-columns: 1fr; }
            .keyboard-help { display: none; }
        }
        @media (max-height: 600px) and (orientation: landscape) {
            .app-container { padding: 5px; }
            header { padding: 8px; margin-bottom: 8px; }
            header h1 { font-size: 1.2rem; }
            .controls-panel, .display-panel { padding: 8px; margin-bottom: 8px; }
            .compositions-panel, .keyboard-help { display: none; }
            .visualizer { height: 40px; margin-bottom: 8px; }
            .white-key { height: 120px; }
            .black-key { height: 70px; }
        }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; background: rgba(0,0,0,0.9); border-radius: 10px; color: white; font-size: 0.9rem; animation: slideIn 0.3s ease; border-left: 4px solid var(--accent); }
        .toast.success { border-left-color: #4caf50; }
        .toast.error { border-left-color: #f44336; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="loading-spinner"></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <header><h1>üéπ Interactive Piano</h1></header>
        <div class="visualizer" id="visualizer"></div>
        <div class="controls-panel">
            <div class="control-group">
                <label>Volume</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70">
            </div>
            <div class="control-group">
                <label>Octave</label>
                <select id="octaveSelect">
                    <option value="2">Octave 2</option>
                    <option value="3">Octave 3</option>
                    <option value="4" selected>Octave 4</option>
                    <option value="5">Octave 5</option>
                    <option value="6">Octave 6</option>
                </select>
            </div>
            <div class="control-group">
                <label>Instrument</label>
                <select id="instrumentSelect">
                    <option value="piano">Grand Piano</option>
                    <option value="electric">Electric Piano</option>
                    <option value="organ">Organ</option>
                    <option value="synth">Synthesizer</option>
                </select>
            </div>
            <button id="recordBtn">‚è∫ Record</button>
            <button id="playBtn">‚ñ∂ Play</button>
            <button id="stopBtn">‚èπ Stop</button>
            <button id="saveBtn">üíæ Save</button>
            <button id="uploadBtn">üì§ Upload</button>
            <button id="downloadBtn">üì• Download</button>
        </div>
        <div class="display-panel">
            <div class="display-header">
                <span class="now-playing" id="nowPlaying">Ready to play</span>
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>Recording...</span>
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
        <div class="keyboard-help">
            <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
            <div class="keyboard-shortcuts">
                <div class="shortcut-item"><span class="shortcut-key">A</span>C</div>
                <div class="shortcut-item"><span class="shortcut-key">W</span>C#</div>
                <div class="shortcut-item"><span class="shortcut-key">S</span>D</div>
                <div class="shortcut-item"><span class="shortcut-key">E</span>D#</div>
                <div class="shortcut-item"><span class="shortcut-key">D</span>E</div>
                <div class="shortcut-item"><span class="shortcut-key">F</span>F</div>
                <div class="shortcut-item"><span class="shortcut-key">T</span>F#</div>
                <div class="shortcut-item"><span class="shortcut-key">G</span>G</div>
                <div class="shortcut-item"><span class="shortcut-key">Y</span>G#</div>
                <div class="shortcut-item"><span class="shortcut-key">H</span>A</div>
                <div class="shortcut-item"><span class="shortcut-key">U</span>A#</div>
                <div class="shortcut-item"><span class="shortcut-key">J</span>B</div>
                <div class="shortcut-item"><span class="shortcut-key">K</span>C+</div>
                <div class="shortcut-item"><span class="shortcut-key">L</span>D+</div>
            </div>
        </div>
        <div class="piano-container"><div class="piano" id="piano"></div></div>
        <div class="compositions-panel">
            <div class="compositions-header">
                <h3>üéµ Compositions</h3>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="preinstalled">Preinstalled</button>
                    <button class="tab-btn" data-tab="myrecordings">My Recordings</button>
                </div>
            </div>
            <div class="tab-content active" id="preinstalled">
                <div class="compositions-list" id="preinstalledList"></div>
            </div>
            <div class="tab-content" id="myrecordings">
                <div class="compositions-list" id="myRecordingsList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ Save Recording</h2>
                <button class="close-btn" onclick="closeSaveModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Composition Name</label>
                <input type="text" id="compositionName" placeholder="Enter name...">
            </div>
            <button onclick="saveRecording()" style="width:100%;">Save Composition</button>
        </div>
    </div>

    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Upload Composition</h2>
                <button class="close-btn" onclick="closeUploadModal()">√ó</button>
            </div>
            <div class="form-group">
                <div class="file-input-wrapper">
                    <div class="file-input-label">üìÅ Click or drag to upload JSON file</div>
                    <input type="file" id="fileInput" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, type = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function closeSaveModal() { document.getElementById('saveModal').classList.remove('active'); }
        function closeUploadModal() { document.getElementById('uploadModal').classList.remove('active'); }

        function saveRecording() {
            const name = document.getElementById('compositionName').value.trim();
            if (!name) { showToast('Please enter a name', 'error'); return; }
            if (piano.recording.length === 0) { showToast('No recording to save', 'error'); return; }
            const composition = { id: Date.now(), name, notes: piano.recording, duration: piano.recording[piano.recording.length - 1]?.time || 0 };
            piano.userRecordings.push(composition);
            piano.saveState();
            piano.renderCompositions();
            closeSaveModal();
            showToast('Recording saved!', 'success');
        }

        // Audio Engine with fixed sound generation
        class PianoSound {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.volume = 0.7;
                this.instrument = 'piano';
                this.activeOscillators = new Map();
                this.noteFrequencies = {};
                this.initFrequencies();
            }

            initFrequencies() {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                for (let octave = 0; octave <= 8; octave++) {
                    notes.forEach((note, idx) => {
                        const key = `${note}${octave}`;
                        const halfSteps = (octave - 4) * 12 + (idx - 9);
                        this.noteFrequencies[key] = 440 * Math.pow(2, halfSteps / 12);
                    });
                }
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.gain.value = this.volume;
                    
                    const compressor = this.audioContext.createDynamicsCompressor();
                    compressor.threshold.value = -50;
                    compressor.knee.value = 40;
                    compressor.ratio.value = 12;
                    compressor.attack.value = 0;
                    compressor.release.value = 0.25;
                    
                    this.masterGain.connect(compressor);
                    compressor.connect(this.audioContext.destination);
                }
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }

            setVolume(v) { 
                this.volume = v; 
                if (this.masterGain) this.masterGain.gain.value = v; 
            }
            
            setInstrument(i) { this.instrument = i; }

            getFrequency(note, octave) {
                const key = `${note}${octave}`;
                return this.noteFrequencies[key] || 440;
            }

            playNote(note, octave) {
                this.init();
                const key = `${note}${octave}`;
                
                // Stop existing note if playing
                if (this.activeOscillators.has(key)) {
                    this.stopNote(note, octave);
                }

                const freq = this.getFrequency(note, octave);
                const now = this.audioContext.currentTime;
                
                const noteGain = this.audioContext.createGain();
                noteGain.connect(this.masterGain);
                
                const oscillators = [];

                if (this.instrument === 'piano') {
                    const harmonics = [1, 2, 3, 4, 5, 6, 8];
                    const amps = [0.4, 0.2, 0.15, 0.1, 0.08, 0.06, 0.04];
                    
                    harmonics.forEach((h, i) => {
                        const osc = this.audioContext.createOscillator();
                        const oscGain = this.audioContext.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq * h, now);
                        oscGain.gain.setValueAtTime(amps[i], now);
                        osc.connect(oscGain);
                        oscGain.connect(noteGain);
                        osc.start(now);
                        oscillators.push(osc);
                    });
                    
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.8, now + 0.01);
                    noteGain.gain.exponentialRampToValueAtTime(0.4, now + 0.1);
                    noteGain.gain.exponentialRampToValueAtTime(0.2, now + 0.5);
                    noteGain.gain.exponentialRampToValueAtTime(0.1, now + 2);
                    
                } else if (this.instrument === 'electric') {
                    const osc1 = this.audioContext.createOscillator();
                    const osc2 = this.audioContext.createOscillator();
                    osc1.type = 'sine';
                    osc2.type = 'triangle';
                    osc1.frequency.setValueAtTime(freq, now);
                    osc2.frequency.setValueAtTime(freq * 2, now);
                    
                    const g1 = this.audioContext.createGain();
                    const g2 = this.audioContext.createGain();
                    g1.gain.setValueAtTime(0.4, now);
                    g2.gain.setValueAtTime(0.15, now);
                    
                    osc1.connect(g1); g1.connect(noteGain);
                    osc2.connect(g2); g2.connect(noteGain);
                    osc1.start(now); osc2.start(now);
                    oscillators.push(osc1, osc2);
                    
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.7, now + 0.02);
                    noteGain.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                    
                } else if (this.instrument === 'organ') {
                    const harmonics = [0.5, 1, 2, 3, 4, 6, 8];
                    const amps = [0.3, 0.5, 0.4, 0.3, 0.2, 0.15, 0.1];
                    
                    harmonics.forEach((h, i) => {
                        const osc = this.audioContext.createOscillator();
                        const oscGain = this.audioContext.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq * h, now);
                        oscGain.gain.setValueAtTime(amps[i], now);
                        osc.connect(oscGain);
                        oscGain.connect(noteGain);
                        osc.start(now);
                        oscillators.push(osc);
                    });
                    
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.5, now + 0.05);
                    
                } else if (this.instrument === 'synth') {
                    const osc1 = this.audioContext.createOscillator();
                    const osc2 = this.audioContext.createOscillator();
                    osc1.type = 'sawtooth';
                    osc2.type = 'square';
                    osc1.frequency.setValueAtTime(freq, now);
                    osc2.frequency.setValueAtTime(freq * 1.005, now);
                    
                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(freq * 8, now);
                    filter.frequency.exponentialRampToValueAtTime(freq * 2, now + 0.5);
                    filter.Q.setValueAtTime(5, now);
                    
                    const g1 = this.audioContext.createGain();
                    const g2 = this.audioContext.createGain();
                    g1.gain.setValueAtTime(0.25, now);
                    g2.gain.setValueAtTime(0.15, now);
                    
                    osc1.connect(g1); osc2.connect(g2);
                    g1.connect(filter); g2.connect(filter);
                    filter.connect(noteGain);
                    osc1.start(now); osc2.start(now);
                    oscillators.push(osc1, osc2);
                    
                    noteGain.gain.setValueAtTime(0, now);
                    noteGain.gain.linearRampToValueAtTime(0.6, now + 0.03);
                    noteGain.gain.exponentialRampToValueAtTime(0.3, now + 0.3);
                }

                this.activeOscillators.set(key, { oscillators, noteGain });
                this.updateVisualizer(freq);
            }

            stopNote(note, octave) {
                const key = `${note}${octave}`;
                const active = this.activeOscillators.get(key);
                
                if (active) {
                    const { oscillators, noteGain } = active;
                    const now = this.audioContext.currentTime;
                    const releaseTime = this.instrument === 'organ' ? 0.1 : 0.3;
                    
                    noteGain.gain.cancelScheduledValues(now);
                    noteGain.gain.setValueAtTime(noteGain.gain.value, now);
                    noteGain.gain.exponentialRampToValueAtTime(0.001, now + releaseTime);
                    
                    oscillators.forEach(osc => {
                        osc.stop(now + releaseTime + 0.1);
                    });
                    
                    this.activeOscillators.delete(key);
                }
            }

            updateVisualizer(freq) {
                const bars = document.querySelectorAll('.visualizer-bar');
                const nf = Math.log2(freq / 100);
                bars.forEach((bar, i) => {
                    const h = Math.min(Math.random() * 30 + nf * 8 + 10, 55);
                    bar.style.height = `${h}px`;
                    setTimeout(() => bar.style.height = '5px', 150 + i * 10);
                });
            }
        }

        // Extended melodies with longer compositions
        const MELODIES = {
            "F√ºr Elise (Beethoven)": `
                E5.2 D#5.2 E5.2 D#5.2 E5.2 B4.2 D5.2 C5.2 A4.4 -.2 C4.2 E4.2 A4.2 B4.4 -.2 E4.2 G#4.2 B4.2 C5.4 -.2 E4.2
                E5.2 D#5.2 E5.2 D#5.2 E5.2 B4.2 D5.2 C5.2 A4.4 -.2 C4.2 E4.2 A4.2 B4.4 -.2 E4.2 C5.2 B4.2 A4.8
                E5.2 D#5.2 E5.2 D#5.2 E5.2 B4.2 D5.2 C5.2 A4.4 -.2 C4.2 E4.2 A4.2 B4.4 -.2 E4.2 G#4.2 B4.2 C5.4 -.2 E4.2
                E5.2 D#5.2 E5.2 D#5.2 E5.2 B4.2 D5.2 C5.2 A4.4 -.2 C4.2 E4.2 A4.2 B4.4 -.2 E4.2 C5.2 B4.2 A4.8
                B4.2 C5.2 D5.2 E5.4 G4.2 F5.2 E5.2 D5.4 F4.2 E5.2 D5.2 C5.4 E4.2 D5.2 C5.2 B4.8
            `,
            "Twinkle Twinkle Little Star": `
                C4.4 C4.4 G4.4 G4.4 A4.4 A4.4 G4.8 F4.4 F4.4 E4.4 E4.4 D4.4 D4.4 C4.8
                G4.4 G4.4 F4.4 F4.4 E4.4 E4.4 D4.8 G4.4 G4.4 F4.4 F4.4 E4.4 E4.4 D4.8
                C4.4 C4.4 G4.4 G4.4 A4.4 A4.4 G4.8 F4.4 F4.4 E4.4 E4.4 D4.4 D4.4 C4.8
                G4.4 G4.4 F4.4 F4.4 E4.4 E4.4 D4.8 G4.4 G4.4 F4.4 F4.4 E4.4 E4.4 D4.8
                C4.4 C4.4 G4.4 G4.4 A4.4 A4.4 G4.8 F4.4 F4.4 E4.4 E4.4 D4.4 D4.4 C4.16
            `,
            "Happy Birthday": `
                C4.3 C4.1 D4.4 C4.4 F4.4 E4.8 C4.3 C4.1 D4.4 C4.4 G4.4 F4.8
                C4.3 C4.1 C5.4 A4.4 F4.4 E4.4 D4.8 A#4.3 A#4.1 A4.4 F4.4 G4.4 F4.8
                C4.3 C4.1 D4.4 C4.4 F4.4 E4.8 C4.3 C4.1 D4.4 C4.4 G4.4 F4.8
                C4.3 C4.1 C5.4 A4.4 F4.4 E4.4 D4.8 A#4.3 A#4.1 A4.4 F4.4 G4.4 F4.16
            `,
            "Ode to Joy (Beethoven)": `
                E4.4 E4.4 F4.4 G4.4 G4.4 F4.4 E4.4 D4.4 C4.4 C4.4 D4.4 E4.4 E4.6 D4.2 D4.8
                E4.4 E4.4 F4.4 G4.4 G4.4 F4.4 E4.4 D4.4 C4.4 C4.4 D4.4 E4.4 D4.6 C4.2 C4.8
                D4.4 D4.4 E4.4 C4.4 D4.4 E4.2 F4.2 E4.4 C4.4 D4.4 E4.2 F4.2 E4.4 D4.4 C4.4 D4.4 G3.8
                E4.4 E4.4 F4.4 G4.4 G4.4 F4.4 E4.4 D4.4 C4.4 C4.4 D4.4 E4.4 D4.6 C4.2 C4.8
                E4.4 E4.4 F4.4 G4.4 G4.4 F4.4 E4.4 D4.4 C4.4 C4.4 D4.4 E4.4 D4.6 C4.2 C4.16
            `,
            "Canon in D (Pachelbel)": `
                F#5.8 E5.8 D5.8 C#5.8 B4.8 A4.8 B4.8 C#5.8
                D5.8 C#5.8 B4.8 A4.8 G4.8 F#4.8 G4.8 A4.8
                D4.4 F#4.4 A4.4 G4.4 F#4.4 D4.4 F#4.4 E4.4
                D4.4 B3.4 D4.4 A4.4 G4.4 B4.4 A4.4 G4.4
                F#4.4 D4.4 E4.4 C#5.4 D5.4 F#5.4 A5.4 A4.4
                B4.4 G4.4 A4.4 F#4.4 D4.4 D5.4 D5.2 C#5.2 D5.2 E5.2 D5.2 C#5.2 B4.2 C#5.2
                D5.8 A4.8 B4.8 G4.8 A4.8 F#4.8 G4.8 A4.16
            `,
            "Moonlight Sonata (Beethoven)": `
                G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2
                G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2
                A3.2 C#4.2 E4.2 A3.2 C#4.2 E4.2 A3.2 C#4.2 E4.2 A3.2 C#4.2 E4.2
                G#3.2 B3.2 E4.2 G#3.2 B3.2 E4.2 G#3.2 B3.2 E4.2 G#3.2 B3.2 E4.2
                G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2 G#3.2 C#4.2 E4.2
                G#3.2 C#4.2 D#4.2 G#3.2 C#4.2 D#4.2 F#3.2 B3.2 D#4.2 F#3.2 B3.2 D#4.2
                E3.2 G#3.2 C#4.2 E4.2 G#4.2 C#5.2 E5.16
            `,
            "Mary Had a Little Lamb": `
                E4.4 D4.4 C4.4 D4.4 E4.4 E4.4 E4.8 D4.4 D4.4 D4.8 E4.4 G4.4 G4.8
                E4.4 D4.4 C4.4 D4.4 E4.4 E4.4 E4.4 E4.4 D4.4 D4.4 E4.4 D4.4 C4.8
                E4.4 D4.4 C4.4 D4.4 E4.4 E4.4 E4.8 D4.4 D4.4 D4.8 E4.4 G4.4 G4.8
                E4.4 D4.4 C4.4 D4.4 E4.4 E4.4 E4.4 E4.4 D4.4 D4.4 E4.4 D4.4 C4.16
            `,
            "Jingle Bells": `
                E4.4 E4.4 E4.8 E4.4 E4.4 E4.8 E4.4 G4.4 C4.4 D4.4 E4.16
                F4.4 F4.4 F4.4 F4.4 F4.4 E4.4 E4.4 E4.2 E4.2 E4.4 D4.4 D4.4 E4.4 D4.8 G4.8
                E4.4 E4.4 E4.8 E4.4 E4.4 E4.8 E4.4 G4.4 C4.4 D4.4 E4.16
                F4.4 F4.4 F4.4 F4.4 F4.4 E4.4 E4.4 E4.2 E4.2 G4.4 G4.4 F4.4 D4.4 C4.16
                G4.4 E4.4 D4.4 C4.4 G3.8 G3.4 G4.4 E4.4 D4.4 C4.4 A3.16
                A4.4 F4.4 E4.4 D4.4 B3.8 G4.4 G4.4 G4.4 A4.4 G4.4 F4.4 D4.4 E4.4 C4.16
            `,
            "Amazing Grace": `
                G3.4 C4.8 E4.2 C4.2 E4.6 D4.4 C4.6 A3.2 G3.6 G3.4 C4.8 E4.2 C4.2 E4.6 D4.6 G4.16
                G4.4 E4.6 G4.2 E4.2 G4.2 E4.6 D4.4 C4.6 A3.2 G3.6 G3.4 C4.8 E4.2 C4.2 E4.6 D4.4 C4.16
                G3.4 C4.8 E4.2 C4.2 E4.6 D4.4 C4.6 A3.2 G3.6 G3.4 C4.8 E4.2 C4.2 E4.6 D4.6 G4.16
                G4.4 E4.6 G4.2 E4.2 G4.2 E4.6 D4.4 C4.6 A3.2 G3.6 G3.4 C4.8 E4.2 C4.2 E4.6 D4.4 C4.16
            `,
            "Chopsticks": `
                F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.4
                E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.4
                D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.4
                C4|C5.8
                F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.2 F4|G4.4
                E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.2 E4|G4.4
                D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.2 D4|B4.4
                C4|C5.8
                G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.4
                A4|F5.2 A4|F5.2 A4|F5.2 A4|F5.2 A4|F5.2 A4|F5.4
                G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.2 G4|E5.4
                C4|C5.16
            `,
            "London Bridge": `
                G4.4 A4.2 G4.2 F4.4 E4.4 F4.4 G4.8 D4.4 E4.4 F4.8 E4.4 F4.4 G4.8
                G4.4 A4.2 G4.2 F4.4 E4.4 F4.4 G4.8 D4.8 G4.4 E4.4 C4.8
                D4.4 E4.4 F4.8 E4.4 F4.4 G4.8 G4.4 A4.2 G4.2 F4.4 E4.4 F4.4 G4.8
                D4.8 G4.4 E4.4 C4.16
            `,
            "Row Row Row Your Boat": `
                C4.6 C4.6 C4.4 D4.2 E4.6 E4.4 D4.2 E4.4 F4.2 G4.12
                C5.2 C5.2 C5.2 G4.2 G4.2 G4.2 E4.2 E4.2 E4.2 C4.2 C4.2 C4.2
                G4.4 F4.2 E4.4 D4.2 C4.12
                C4.6 C4.6 C4.4 D4.2 E4.6 E4.4 D4.2 E4.4 F4.2 G4.12
                C5.2 C5.2 C5.2 G4.2 G4.2 G4.2 E4.2 E4.2 E4.2 C4.2 C4.2 C4.2
                G4.4 F4.2 E4.4 D4.2 C4.16
            `,
            "Auld Lang Syne": `
                G3.4 C4.8 C4.4 C4.6 E4.6 D4.6 C4.4 D4.6 E4.4 D4.6 C4.8 C4.4 E4.6 G4.6 A4.16
                A4.4 G4.6 E4.4 E4.6 C4.6 D4.6 C4.4 D4.4 E4.2 D4.2 C4.6 A3.6 A3.4 G3.6 C4.16
                G3.4 C4.8 C4.4 C4.6 E4.6 D4.6 C4.4 D4.6 E4.4 D4.6 C4.8 C4.4 E4.6 G4.6 A4.16
                A4.4 G4.6 E4.4 E4.6 C4.6 D4.6 C4.4 D4.4 E4.2 D4.2 C4.6 A3.6 A3.4 G3.6 C4.16
            `,
            "Brahms Lullaby": `
                G4.3 G4.3 A#4.8 G4.3 G4.3 A#4.8 G4.6 A#4.6 D5.6 C5.8
                A4.6 A#4.6 C5.6 A#4.8 F4.6 G4.6 A4.6 A#4.16
                G4.3 G4.3 A#4.8 G4.3 G4.3 A#4.8 G4.6 A#4.6 D5.6 C5.8
                A4.6 A#4.6 C5.6 A#4.8 F4.6 G4.6 A4.6 A#4.16
                D5.6 D5.6 C5.6 A4.8 A#4.6 A#4.6 A4.6 F4.8
                G4.6 A#4.6 A4.6 G4.8 F4.6 G4.6 A4.6 A#4.16
            `,
            "Silent Night": `
                G4.6 A4.2 G4.6 E4.12 G4.6 A4.2 G4.6 E4.12
                D5.6 D5.6 B4.12 C5.6 C5.6 G4.12
                A4.6 A4.6 C5.3 B4.3 A4.6 G4.6 A4.2 G4.6 E4.12
                A4.6 A4.6 C5.3 B4.3 A4.6 G4.6 A4.2 G4.6 E4.12
                D5.6 D5.6 F5.3 D5.3 B4.6 C5.12 E5.12
                C5.6 G4.6 E4.6 G4.3 F4.3 E4.6 C4.16
            `,
            "When The Saints Go Marching In": `
                C4.4 E4.4 F4.4 G4.12 C4.4 E4.4 F4.4 G4.12
                C4.4 E4.4 F4.4 G4.8 E4.8 C4.8 E4.8 D4.12
                E4.4 E4.4 D4.4 C4.8 C4.4 E4.8 G4.8 G4.4 F4.12
                E4.4 F4.4 G4.8 E4.8 C4.8 D4.8 C4.12
                C4.4 E4.4 F4.4 G4.12 C4.4 E4.4 F4.4 G4.12
                C4.4 E4.4 F4.4 G4.8 E4.8 C4.8 E4.8 D4.12
                E4.4 E4.4 D4.4 C4.8 C4.4 E4.8 G4.8 G4.4 F4.12
                E4.4 F4.4 G4.8 E4.8 C4.8 D4.8 C4.16
            `,
            "Yankee Doodle": `
                C4.4 C4.4 D4.4 E4.4 C4.4 E4.4 D4.4 G3.4
                C4.4 C4.4 D4.4 E4.4 C4.8 B3.8
                C4.4 C4.4 D4.4 E4.4 F4.4 E4.4 D4.4 C4.4
                B3.4 G3.4 A3.4 B3.4 C4.8 C4.8
                A3.4 B3.4 C4.4 C4.4 A3.4 B3.4 C4.4 D4.4
                E4.4 C4.4 A3.4 G3.4 A3.8 A3.8
                A3.4 B3.4 C4.4 C4.4 B3.4 A3.4 G3.4 A3.4
                B3.4 C4.4 D4.4 E4.4 C4.16
            `,
            "Old MacDonald Had a Farm": `
                G4.4 G4.4 G4.4 D4.4 E4.4 E4.4 D4.8
                B4.4 B4.4 A4.4 A4.4 G4.8
                D4.4 G4.4 G4.4 G4.4 D4.4 E4.4 E4.4 D4.8
                B4.4 B4.4 A4.4 A4.4 G4.8
                D4.2 D4.2 G4.4 G4.4 G4.4 D4.2 D4.2 G4.4 G4.4 G4.8
                G4.4 G4.4 G4.4 D4.4 E4.4 E4.4 D4.8
                B4.4 B4.4 A4.4 A4.4 G4.16
            `,
            "Greensleeves": `
                A4.4 C5.6 D5.2 E5.5 F5.1 E5.4 D5.6 B4.2 G4.5 A4.1 B4.4 C5.6 A4.2 A4.5 G#4.1 A4.4 B4.6 G#4.2 E4.8
                A4.4 C5.6 D5.2 E5.5 F5.1 E5.4 D5.6 B4.2 G4.5 A4.1 B4.4 C5.5 B4.1 A4.4 G#4.5 F#4.1 G#4.4 A4.12
                G5.6 G5.2 G5.5 F#5.1 E5.4 D5.6 B4.2 G4.5 A4.1 B4.4 C5.6 A4.2 A4.5 G#4.1 A4.4 B4.6 G#4.2 E4.8
                G5.6 G5.2 G5.5 F#5.1 E5.4 D5.6 B4.2 G4.5 A4.1 B4.4 C5.5 B4.1 A4.4 G#4.5 F#4.1 G#4.4 A4.16
            `,
            "Scarborough Fair": `
                A4.8 A4.4 E4.4 A4.4 B4.4 C5.6 B4.2 A4.8
                G4.4 A4.4 E4.4 D4.8 A3.16
                A4.8 D5.4 D5.4 D5.4 C5.4 B4.6 A4.2 B4.4 C5.4 B4.4 A4.4 G4.8
                A4.8 A4.4 G4.4 E4.4 G4.4 A4.6 G4.2 E4.8 D4.8 A3.16
                A4.8 A4.4 E4.4 A4.4 B4.4 C5.6 B4.2 A4.8
                G4.4 A4.4 E4.4 D4.8 A3.16
            `
        };

        function parseMelody(melodyStr) {
            const notes = [];
            const parts = melodyStr.trim().split(/\s+/).filter(p => p && p !== '-');
            let time = 0;
            const unitMs = 120;

            parts.forEach(part => {
                if (part.startsWith('-')) {
                    const durMatch = part.match(/\.(\d+)/);
                    if (durMatch) time += parseInt(durMatch[1]) * unitMs;
                    return;
                }

                const [notesPart, durStr] = part.split('.');
                if (!durStr) return;
                
                const duration = parseInt(durStr) * unitMs;
                const simultaneousNotes = notesPart.split('|');

                simultaneousNotes.forEach(noteStr => {
                    const match = noteStr.match(/([A-G]#?)(\d)/);
                    if (match) {
                        const note = match[1];
                        const octave = parseInt(match[2]);
                        notes.push({ type: 'noteOn', note, octave, time });
                        notes.push({ type: 'noteOff', note, octave, time: time + duration - 20 });
                    }
                });

                time += duration;
            });

            return notes;
        }

        const preinstalledCompositions = Object.entries(MELODIES).map(([name, melody], idx) => {
            const notes = parseMelody(melody);
            return { id: idx + 1, name, notes, duration: notes.length > 0 ? notes[notes.length - 1].time + 200 : 0 };
        });

        class Piano {
            constructor() {
                this.sound = new PianoSound();
                this.octave = 4;
                this.isRecording = false;
                this.isPlaying = false;
                this.recording = [];
                this.recordingStartTime = 0;
                this.currentComposition = null;
                this.playbackTimeouts = [];
                this.userRecordings = [];
                this.activeKeys = new Set();
                this.keyboardMap = { 'a':'C','w':'C#','s':'D','e':'D#','d':'E','f':'F','t':'F#','g':'G','y':'G#','h':'A','u':'A#','j':'B','k':'C+','o':'C#+','l':'D+' };
                this.init();
            }

            init() {
                this.createPiano();
                this.createVisualizer();
                this.setupEventListeners();
                this.loadState();
                this.renderCompositions();
                setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
            }

            createPiano() {
                const piano = document.getElementById('piano');
                piano.innerHTML = '';
                const whiteNotes = ['C','D','E','F','G','A','B'];
                const blackNotes = ['C#','D#',null,'F#','G#','A#',null];
                const whiteLabels = ['A','S','D','F','G','H','J','K','L',';'];
                const blackLabels = ['W','E','','T','Y','U','','O','P'];
                let wi = 0, bi = 0;

                for (let o = 0; o < 2; o++) {
                    whiteNotes.forEach((note, i) => {
                        const oct = this.octave + o;
                        const key = document.createElement('div');
                        key.className = 'key white-key';
                        key.dataset.note = note;
                        key.dataset.octave = oct;
                        key.innerHTML = `<span class="key-label">${whiteLabels[wi] || ''}</span>`;
                        piano.appendChild(key);
                        wi++;

                        if (blackNotes[i]) {
                            const bkey = document.createElement('div');
                            bkey.className = 'key black-key';
                            bkey.dataset.note = blackNotes[i];
                            bkey.dataset.octave = oct;
                            bkey.innerHTML = `<span class="key-label">${blackLabels[bi] || ''}</span>`;
                            piano.appendChild(bkey);
                        }
                        bi++;
                    });
                }
                this.positionBlackKeys();
            }

            positionBlackKeys() {
                const piano = document.getElementById('piano');
                const whites = piano.querySelectorAll('.white-key');
                const blacks = piano.querySelectorAll('.black-key');
                if (!whites.length) return;
                const ww = whites[0].offsetWidth + 2;
                const bw = 32;
                const pattern = [1,1,0,1,1,1,0];
                let bi = 0;
                for (let i = 0; i < whites.length && bi < blacks.length; i++) {
                    if (pattern[i % 7]) {
                        blacks[bi].style.left = `${(i + 1) * ww - bw / 2 + 14}px`;
                        bi++;
                    }
                }
            }

            createVisualizer() {
                const v = document.getElementById('visualizer');
                v.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    bar.style.height = '5px';
                    v.appendChild(bar);
                }
            }

            setupEventListeners() {
                const piano = document.getElementById('piano');
                
                piano.addEventListener('mousedown', e => { e.preventDefault(); this.handleKeyPress(e); });
                piano.addEventListener('mouseup', e => this.handleKeyRelease(e));
                piano.addEventListener('mouseleave', () => this.releaseAllKeys());
                piano.addEventListener('mouseover', e => { if (e.buttons === 1) this.handleKeyPress(e); });
                piano.addEventListener('mouseout', e => { if (e.buttons === 1) this.handleKeyRelease(e); });

                piano.addEventListener('touchstart', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) this.playKeyByElement(key);
                    });
                }, { passive: false });

                piano.addEventListener('touchend', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) this.releaseKeyByElement(key);
                    });
                }, { passive: false });

                piano.addEventListener('touchmove', e => {
                    e.preventDefault();
                    Array.from(e.changedTouches).forEach(t => {
                        const key = document.elementFromPoint(t.clientX, t.clientY);
                        if (key?.classList.contains('key')) {
                            const keyId = `${key.dataset.note}${key.dataset.octave}`;
                            if (!this.activeKeys.has(keyId)) {
                                this.releaseAllKeys();
                                this.playKeyByElement(key);
                            }
                        }
                    });
                }, { passive: false });

                document.addEventListener('keydown', e => {
                    if (e.repeat || e.target.tagName === 'INPUT') return;
                    this.handleKeyboardPress(e.key.toLowerCase());
                });
                document.addEventListener('keyup', e => {
                    if (e.target.tagName === 'INPUT') return;
                    this.handleKeyboardRelease(e.key.toLowerCase());
                });

                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
                document.getElementById('playBtn').addEventListener('click', () => this.playRecording());
                document.getElementById('stopBtn').addEventListener('click', () => this.stop());
                document.getElementById('saveBtn').addEventListener('click', () => this.openSaveModal());
                document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('uploadModal').classList.add('active'));
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadRecording());

                document.getElementById('volumeSlider').addEventListener('input', e => {
                    this.sound.setVolume(e.target.value / 100);
                    this.saveState();
                });

                document.getElementById('octaveSelect').addEventListener('change', e => {
                    this.octave = parseInt(e.target.value);
                    this.createPiano();
                    this.saveState();
                });

                document.getElementById('instrumentSelect').addEventListener('change', e => {
                    this.sound.setInstrument(e.target.value);
                    this.saveState();
                    showToast(`Instrument: ${e.target.options[e.target.selectedIndex].text}`);
                });

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                    });
                });

                document.getElementById('fileInput').addEventListener('change', e => this.handleFileUpload(e));
                window.addEventListener('resize', () => this.positionBlackKeys());

                ['click', 'touchstart', 'keydown'].forEach(evt => {
                    document.addEventListener(evt, () => this.sound.init(), { once: true });
                });

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
                });
            }

            handleKeyPress(e) {
                const key = e.target.closest('.key');
                if (key) this.playKeyByElement(key);
            }

            handleKeyRelease(e) {
                const key = e.target.closest('.key');
                if (key) this.releaseKeyByElement(key);
            }

            playKeyByElement(key) {
                const note = key.dataset.note;
                const octave = parseInt(key.dataset.octave);
                const id = `${note}${octave}`;
                if (this.activeKeys.has(id)) return;
                this.activeKeys.add(id);
                this.playNote(note, octave);
                key.classList.add('active');
            }

            releaseKeyByElement(key) {
                const note = key.dataset.note;
                const octave = parseInt(key.dataset.octave);
                const id = `${note}${octave}`;
                if (!this.activeKeys.has(id)) return;
                this.activeKeys.delete(id);
                this.stopNote(note, octave);
                key.classList.remove('active');
            }

            releaseAllKeys() {
                document.querySelectorAll('.key.active').forEach(key => {
                    this.releaseKeyByElement(key);
                });
            }

            handleKeyboardPress(k) {
                let note = this.keyboardMap[k];
                if (!note) return;
                let octave = this.octave;
                if (note.includes('+')) { note = note.replace('+', ''); octave++; }
                const id = `${note}${octave}`;
                if (this.activeKeys.has(id)) return;
                this.activeKeys.add(id);
                this.playNote(note, octave);
                this.highlightKey(note, octave, true);
            }

            handleKeyboardRelease(k) {
                let note = this.keyboardMap[k];
                if (!note) return;
                let octave = this.octave;
                if (note.includes('+')) { note = note.replace('+', ''); octave++; }
                const id = `${note}${octave}`;
                if (!this.activeKeys.has(id)) return;
                this.activeKeys.delete(id);
                this.stopNote(note, octave);
                this.highlightKey(note, octave, false);
            }

            playNote(note, octave) {
                this.sound.playNote(note, octave);
                if (this.isRecording) {
                    this.recording.push({ type: 'noteOn', note, octave, time: Date.now() - this.recordingStartTime });
                }
            }

            stopNote(note, octave) {
                this.sound.stopNote(note, octave);
                if (this.isRecording) {
                    this.recording.push({ type: 'noteOff', note, octave, time: Date.now() - this.recordingStartTime });
                }
            }

            highlightKey(note, octave, active) {
                document.querySelectorAll('.key').forEach(key => {
                    if (key.dataset.note === note && parseInt(key.dataset.octave) === octave) {
                        key.classList.toggle('active', active);
                    }
                });
            }

            toggleRecording() {
                if (this.isRecording) {
                    this.isRecording = false;
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordingIndicator').classList.remove('active');
                    document.getElementById('nowPlaying').textContent = this.recording.length ? `Recorded ${this.recording.length} events` : 'No notes recorded';
                    showToast('Recording stopped', 'success');
                } else {
                    this.stop();
                    this.recording = [];
                    this.recordingStartTime = Date.now();
                    this.isRecording = true;
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordingIndicator').classList.add('active');
                    document.getElementById('nowPlaying').textContent = 'Recording...';
                    showToast('Recording started', 'success');
                }
            }

            playRecording() {
                if (!this.recording.length && !this.currentComposition) {
                    showToast('No recording to play', 'error');
                    return;
                }
                this.playComposition(this.currentComposition || { notes: this.recording, name: 'Your Recording' });
            }

            playComposition(comp) {
                this.stop();
                this.isPlaying = true;
                document.getElementById('playBtn').classList.add('active');
                document.getElementById('nowPlaying').textContent = `Playing: ${comp.name}`;

                const notes = comp.notes;
                if (!notes?.length) { this.stop(); return; }

                const totalDuration = notes[notes.length - 1]?.time || 0;
                const startTime = Date.now();

                const progressInterval = setInterval(() => {
                    if (!this.isPlaying) { clearInterval(progressInterval); return; }
                    const progress = Math.min((Date.now() - startTime) / totalDuration * 100, 100);
                    document.getElementById('progressFill').style.width = `${progress}%`;
                }, 50);
                this.playbackTimeouts.push({ clear: () => clearInterval(progressInterval) });

                notes.forEach(event => {
                    const timeout = setTimeout(() => {
                        if (!this.isPlaying) return;
                        if (event.type === 'noteOn') {
                            this.sound.playNote(event.note, event.octave);
                            this.highlightKey(event.note, event.octave, true);
                        } else {
                            this.sound.stopNote(event.note, event.octave);
                            this.highlightKey(event.note, event.octave, false);
                        }
                    }, event.time);
                    this.playbackTimeouts.push(timeout);
                });

                this.playbackTimeouts.push(setTimeout(() => {
                    this.stop();
                    showToast('Playback finished');
                }, totalDuration + 500));
            }

            stop() {
                this.isPlaying = false;
                this.playbackTimeouts.forEach(t => {
                    if (typeof t === 'number') clearTimeout(t);
                    else if (t?.clear) t.clear();
                });
                this.playbackTimeouts = [];
                document.getElementById('playBtn').classList.remove('active');
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('nowPlaying').textContent = 'Ready to play';
                document.querySelectorAll('.key').forEach(key => {
                    key.classList.remove('active', 'highlight');
                });
                this.sound.activeOscillators.forEach((_, key) => {
                    const [note, octave] = [key.slice(0, -1), parseInt(key.slice(-1))];
                    this.sound.stopNote(note, octave);
                });
                this.activeKeys.clear();
            }

            openSaveModal() {
                if (!this.recording.length) { showToast('No recording to save!', 'error'); return; }
                document.getElementById('saveModal').classList.add('active');
                document.getElementById('compositionName').focus();
            }

            downloadRecording() {
                if (!this.recording.length) { showToast('No recording to download!', 'error'); return; }
                const data = { name: 'My Piano Recording', notes: this.recording, duration: this.recording[this.recording.length - 1]?.time || 0, createdAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `piano-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                showToast('Recording downloaded!', 'success');
            }

            handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const comp = JSON.parse(event.target.result);
                        if (comp.notes?.length) {
                            comp.id = Date.now();
                            comp.name = comp.name || file.name.replace('.json', '');
                            this.userRecordings.push(comp);
                            this.saveState();
                            this.renderCompositions();
                            closeUploadModal();
                            showToast(`Uploaded: ${comp.name}`, 'success');
                        } else { showToast('Invalid file', 'error'); }
                    } catch { showToast('Error reading file', 'error'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            }

            renderCompositions() {
                const preList = document.getElementById('preinstalledList');
                preList.innerHTML = '';
                preinstalledCompositions.forEach(comp => preList.appendChild(this.createCompItem(comp, false)));

                const myList = document.getElementById('myRecordingsList');
                myList.innerHTML = '';
                if (!this.userRecordings.length) {
                    myList.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No recordings yet</p>';
                } else {
                    this.userRecordings.forEach(comp => myList.appendChild(this.createCompItem(comp, true)));
                }
            }

            createCompItem(comp, isUser) {
                const item = document.createElement('div');
                item.className = `composition-item ${isUser ? 'user-composition' : ''}`;
                const dur = Math.round((comp.duration || 0) / 1000);
                const min = Math.floor(dur / 60);
                const sec = dur % 60;
                item.innerHTML = `
                    <span class="composition-icon">${isUser ? 'üéµ' : 'üéº'}</span>
                    <div class="composition-info">
                        <div class="composition-title">${comp.name}</div>
                        <div class="composition-duration">${min}:${sec.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="composition-actions">
                        <button class="play-btn">‚ñ∂</button>
                        ${isUser ? '<button class="delete-btn">üóë</button>' : ''}
                    </div>
                `;
                item.querySelector('.play-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    this.currentComposition = comp;
                    this.playComposition(comp);
                });
                if (isUser) {
                    item.querySelector('.delete-btn').addEventListener('click', e => {
                        e.stopPropagation();
                        if (confirm('Delete this recording?')) {
                            this.userRecordings = this.userRecordings.filter(c => c.id !== comp.id);
                            this.saveState();
                            this.renderCompositions();
                            showToast('Deleted', 'success');
                        }
                    });
                }
                return item;
            }

            saveState() {
                try {
                    localStorage.setItem('pianoState', JSON.stringify({
                        userRecordings: this.userRecordings,
                        volume: this.sound.volume,
                        octave: this.octave,
                        instrument: this.sound.instrument
                    }));
                } catch {}
            }

            loadState() {
                try {
                    const saved = localStorage.getItem('pianoState');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.userRecordings = state.userRecordings || [];
                        this.sound.setVolume(state.volume ?? 0.7);
                        this.octave = state.octave || 4;
                        this.sound.setInstrument(state.instrument || 'piano');
                        document.getElementById('volumeSlider').value = (state.volume ?? 0.7) * 100;
                        document.getElementById('octaveSelect').value = state.octave || 4;
                        document.getElementById('instrumentSelect').value = state.instrument || 'piano';
                    }
                } catch {}
            }
        }

        let piano;
        document.addEventListener('DOMContentLoaded', () => { piano = new Piano(); });
    </script>
</body>
</html>
