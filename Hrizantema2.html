<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ - –ö–≤—ñ—Ç–∫–æ–≤–∏–π –ú–∞–≥–∞–∑–∏–Ω</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #e91e63;
            --primary-dark: #c2185b;
            --secondary: #9c27b0;
            --accent: #ff9800;
            --bg-gradient: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 50%, #e8f5e9 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #2d2d2d;
            --text-light: #666;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 60px rgba(233, 30, 99, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .bg-flowers {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .floating-flower {
            position: absolute;
            font-size: 2rem;
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(10deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(20px) rotate(-10deg); }
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            text-align: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .logo-flower {
            font-size: 3rem;
            animation: bloom 2s infinite ease-in-out;
        }

        @keyframes bloom {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .logo h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .logo p {
            width: 100%;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        nav button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav button:hover, nav button.active {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
        }

        .cart-count {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        nav button.active .cart-count {
            background: var(--primary);
            color: white;
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-title h2 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .section-title p {
            color: var(--text-light);
        }

        .filters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--card-bg);
            border: 2px solid transparent;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-btn:hover, .filter-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.4s ease;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
        }

        .product-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6rem;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            position: relative;
            overflow: hidden;
        }

        .product-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .product-info {
            padding: 20px;
        }

        .product-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .product-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
        }

        .add-to-cart {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-to-cart:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
        }

        .add-to-cart.added {
            background: #4caf50;
        }

        .cart-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .cart-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .cart-empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .cart-empty h3 {
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .cart-items {
            margin-bottom: 30px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            background: #fafafa;
        }

        .cart-item-image {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border-radius: 15px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: bold;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: var(--primary);
            color: white;
        }

        .quantity {
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .remove-item {
            background: #ff5252;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .remove-item:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .cart-summary {
            background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .summary-row.total {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
            border-top: 2px solid var(--primary);
            padding-top: 15px;
            margin-top: 15px;
        }

        .checkout-form {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px dashed #ddd;
        }

        .checkout-form h3 {
            margin-bottom: 20px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(233, 30, 99, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }

        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
        }

        .toast {
            background: var(--card-bg);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.success { border-left: 4px solid #4caf50; }
        .toast.error { border-left: 4px solid #f44336; }
        .toast.info { border-left: 4px solid var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-close:hover { color: var(--primary); }

        .order-preview {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .order-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }

        .order-preview-item:last-child { border-bottom: none; }

        .font-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 99999;
            text-align: center;
            display: none;
        }

        .font-loading.active { display: block; }

        .font-loading .spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .font-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        @media (max-width: 768px) {
            .cart-item { flex-wrap: wrap; }
            .cart-item-controls {
                width: 100%;
                justify-content: flex-end;
                margin-top: 10px;
            }
            .form-actions { flex-direction: column; }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            header { padding: 10px; }
            .logo-flower { font-size: 2rem; }
            .logo h1 { font-size: 1.3rem; }
            .logo p { display: none; }
            nav { margin-top: 8px; }
            nav button { padding: 6px 15px; font-size: 0.85rem; }
            main { padding: 15px; }
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
            }
            .product-image { height: 120px; font-size: 4rem; }
            .product-info { padding: 12px; }
        }

        @media print {
            body { background: white; }
            header, nav, .bg-flowers, .form-actions { display: none; }
            .cart-container { box-shadow: none; }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="font-loading" id="fontLoading">
        <div class="spinner-large"></div>
        <p>–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ PDF...</p>
    </div>

    <div class="font-status" id="fontStatus"></div>

    <div class="bg-flowers" id="bgFlowers"></div>

    <header>
        <div class="logo">
            <span class="logo-flower">üå∏</span>
            <h1>–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞</h1>
            <p>–ï–ª–µ–≥–∞–Ω—Ç–Ω–∏–π –∫–≤—ñ—Ç–∫–æ–≤–∏–π –±—É—Ç—ñ–∫</p>
        </div>
        <nav>
            <button class="nav-btn active" data-section="catalog">
                <span>üå∑</span> –ö–∞—Ç–∞–ª–æ–≥
            </button>
            <button class="nav-btn" data-section="cart">
                <span>üõí</span> –ö–æ—à–∏–∫
                <span class="cart-count" id="cartCount">0</span>
            </button>
        </nav>
    </header>

    <main>
        <section class="section active" id="catalog">
            <div class="section-title">
                <h2>üå∫ –ù–∞—à–∞ —á—É–¥–æ–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—è</h2>
                <p>–í—ñ–¥–±—ñ—Ä–Ω—ñ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏ —Ç–∞ —Å–µ–∑–æ–Ω–Ω—ñ –∫–≤—ñ—Ç–∏</p>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="all">–£—Å—ñ –∫–≤—ñ—Ç–∏</button>
                <button class="filter-btn" data-filter="chrysanthemum">–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∏</button>
                <button class="filter-btn" data-filter="bouquet">–ë—É–∫–µ—Ç–∏</button>
                <button class="filter-btn" data-filter="arrangement">–ö–æ–º–ø–æ–∑–∏—Ü—ñ—ó</button>
                <button class="filter-btn" data-filter="special">–û—Å–æ–±–ª–∏–≤—ñ</button>
            </div>

            <div class="products-grid" id="productsGrid"></div>
        </section>

        <section class="section" id="cart">
            <div class="section-title">
                <h2>üõí –í–∞—à –∫–æ—à–∏–∫</h2>
                <p>–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –≤–∏–±—Ä–∞–Ω–µ —Ç–∞ –æ—Ñ–æ—Ä–º—ñ—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>
            </div>

            <div class="cart-container">
                <div id="cartContent"></div>
            </div>
        </section>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìß –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="recipientEmail">Email –∞–¥—Ä–µ—Å–∞ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
                <input type="email" id="recipientEmail" placeholder="shop@hrizantema.com.ua">
            </div>
            <div class="form-group">
                <label for="emailSubject">–¢–µ–º–∞ –ª–∏—Å—Ç–∞</label>
                <input type="text" id="emailSubject" value="–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–≤—ñ—Ç—ñ–≤ - –•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞">
            </div>
            <div class="order-preview" id="emailOrderPreview"></div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="sendEmail()">
                    <span>üì§</span> –ù–∞–¥—ñ—Å–ª–∞—Ç–∏
                </button>
                <button class="btn btn-secondary" onclick="closeEmailModal()">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FONT MANAGEMENT FOR CYRILLIC PDF SUPPORT
        // ============================================
        
        let fontData = {
            loaded: false,
            base64: null,
            name: null
        };

        // Font sources with Cyrillic support (in priority order)
        const FONT_SOURCES = [
            {
                name: 'PTSans',
                url: 'https://raw.githubusercontent.com/nickvidal/fonts/main/PTSans-Regular.ttf'
            },
            {
                name: 'Roboto',
                url: 'https://raw.githubusercontent.com/nickvidal/fonts/main/Roboto-Regular.ttf'
            },
            {
                name: 'OpenSans',
                url: 'https://raw.githubusercontent.com/nickvidal/fonts/main/OpenSans-Regular.ttf'
            },
            {
                name: 'NotoSans',
                url: 'https://cdn.jsdelivr.net/gh/nickvidal/fonts@main/NotoSans-Regular.ttf'
            },
            {
                name: 'DejaVuSans',
                url: 'https://cdn.jsdelivr.net/npm/dejavu-fonts-ttf@2.37.3/ttf/DejaVuSans.ttf'
            }
        ];

        // Convert ArrayBuffer to Base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Load font from URL
        async function loadFontFromUrl(fontInfo) {
            try {
                console.log(`Trying to load font: ${fontInfo.name} from ${fontInfo.url}`);
                
                const response = await fetch(fontInfo.url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'force-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                if (arrayBuffer.byteLength < 1000) {
                    throw new Error('Font file too small');
                }
                
                const base64 = arrayBufferToBase64(arrayBuffer);
                
                console.log(`Font ${fontInfo.name} loaded successfully (${arrayBuffer.byteLength} bytes)`);
                
                return {
                    name: fontInfo.name,
                    base64: base64
                };
            } catch (error) {
                console.warn(`Failed to load ${fontInfo.name}:`, error.message);
                return null;
            }
        }

        // Load Cyrillic font (tries multiple sources)
        async function loadCyrillicFont() {
            if (fontData.loaded && fontData.base64) {
                return true;
            }

            updateFontStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à—Ä–∏—Ñ—Ç—É...');
            
            for (const fontSource of FONT_SOURCES) {
                const result = await loadFontFromUrl(fontSource);
                if (result) {
                    fontData = {
                        loaded: true,
                        base64: result.base64,
                        name: result.name
                    };
                    updateFontStatus(`–®—Ä–∏—Ñ—Ç ${result.name} –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚úì`);
                    setTimeout(() => hideFontStatus(), 2000);
                    return true;
                }
            }

            // If all external sources fail, use embedded fallback
            console.log('All external fonts failed, using embedded fallback');
            return await loadEmbeddedFallbackFont();
        }

        // Embedded fallback - basic Cyrillic support using canvas
        async function loadEmbeddedFallbackFont() {
            updateFontStatus('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –º–µ—Ç–æ–¥...');
            fontData.loaded = false;
            return false;
        }

        function updateFontStatus(message) {
            const status = document.getElementById('fontStatus');
            if (status) {
                status.textContent = message;
                status.style.display = 'block';
            }
        }

        function hideFontStatus() {
            const status = document.getElementById('fontStatus');
            if (status) {
                status.style.display = 'none';
            }
        }

        // Preload font on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCyrillicFont();
        });

        // ============================================
        // CURRENCY FORMATTING
        // ============================================
        
        function formatPrice(amount) {
            return amount.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' –≥—Ä–Ω';
        }

        function formatPriceShort(amount) {
            return amount.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // ============================================
        // PRODUCTS DATA
        // ============================================
        
        const products = [
            { id: 1, name: "–†–æ–∂–µ–≤–∞ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∞", description: "–ï–ª–µ–≥–∞–Ω—Ç–Ω—ñ —Ä–æ–∂–µ–≤—ñ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏, —ñ–¥–µ–∞–ª—å–Ω—ñ –¥–ª—è –±—É–¥—å-—è–∫–æ—ó –Ω–∞–≥–æ–¥–∏", price: 450, emoji: "üå∏", category: "chrysanthemum", badge: "–•—ñ—Ç –ø—Ä–æ–¥–∞–∂—ñ–≤" },
            { id: 2, name: "–ë—ñ–ª–∞ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ –ï–ª–µ–≥–∞–Ω—Å", description: "–ß–∏—Å—Ç–æ-–±—ñ–ª—ñ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏, —â–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—é—Ç—å —á–∏—Å—Ç–æ—Ç—É —Ç–∞ –≤—ñ—Ä–Ω—ñ—Å—Ç—å", price: 520, emoji: "üíÆ", category: "chrysanthemum", badge: null },
            { id: 3, name: "–ñ–æ–≤—Ç–∏–π —Å–æ–Ω—è—á–Ω–∏–π –±—É–∫–µ—Ç", description: "–Ø—Å–∫—Ä–∞–≤—ñ –∂–æ–≤—Ç—ñ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏, —â–æ–± –æ—Å–≤—ñ—Ç–∏—Ç–∏ –±—É–¥—å-—è–∫–∏–π –¥–µ–Ω—å", price: 580, emoji: "üåº", category: "bouquet", badge: "–ü–æ–ø—É–ª—è—Ä–Ω–∏–π" },
            { id: 4, name: "–ö–æ—Ä–æ–ª—ñ–≤—Å—å–∫–∞ —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—è", description: "–†–æ–∑–∫—ñ—à–Ω—ñ —Ñ—ñ–æ–ª–µ—Ç–æ–≤—ñ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏ –¥–ª—è –∫–æ—Ä–æ–ª—ñ–≤—Å—å–∫–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—é", price: 650, emoji: "üíú", category: "chrysanthemum", badge: null },
            { id: 5, name: "–ú—ñ–∫—Å —Å–∞–¥–æ–≤–∏–π –±—É–∫–µ—Ç", description: "–ü—Ä–µ–∫—Ä–∞—Å–Ω–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è —Å–µ–∑–æ–Ω–Ω–∏—Ö –∫–≤—ñ—Ç—ñ–≤ —Ç–∞ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º", price: 780, emoji: "üíê", category: "bouquet", badge: "–ù–æ–≤–∏–Ω–∫–∞" },
            { id: 6, name: "–¢—Ä–æ—è–Ω–¥–∏ —Ç–∞ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∏", description: "–ö–ª–∞—Å–∏—á–Ω—ñ —Ç—Ä–æ—è–Ω–¥–∏ –≤ –ø–æ—î–¥–Ω–∞–Ω–Ω—ñ –∑ –Ω—ñ–∂–Ω–∏–º–∏ —Ö—Ä–∏–∑–∞–Ω—Ç–µ–º–∞–º–∏", price: 890, emoji: "üåπ", category: "arrangement", badge: null },
            { id: 7, name: "–°–æ–Ω—è—á–Ω—ñ —Å–æ–Ω—è—à–Ω–∏–∫–∏", description: "–í–µ—Å–µ–ª—ñ —Å–æ–Ω—è—à–Ω–∏–∫–∏ –¥–ª—è –ø–æ—à–∏—Ä–µ–Ω–Ω—è —Ä–∞–¥–æ—Å—Ç—ñ", price: 480, emoji: "üåª", category: "bouquet", badge: null },
            { id: 8, name: "–¢—é–ª—å–ø–∞–Ω–æ–≤–∏–π —Å–∞–¥", description: "–°–≤—ñ–∂—ñ —Ç—é–ª—å–ø–∞–Ω–∏ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤", price: 540, emoji: "üå∑", category: "arrangement", badge: "–°–µ–∑–æ–Ω–Ω–∏–π" },
            { id: 9, name: "–í–∏—à–Ω–µ–≤–∏–π —Ü–≤—ñ—Ç –º—Ä—ñ—ó", description: "–ù—ñ–∂–Ω—ñ –∫–≤—ñ—Ç–∏ –≤–∏—à–Ω—ñ –¥–ª—è –≤–µ—Å–Ω—è–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—é", price: 720, emoji: "üå∏", category: "special", badge: "–û–±–º–µ–∂–µ–Ω–æ" },
            { id: 10, name: "–ì—ñ–±—ñ—Å–∫—É—Å –ü–∞—Ä–∞–¥–∞–π–∑", description: "–ï–∫–∑–æ—Ç–∏—á–Ω—ñ –∫–≤—ñ—Ç–∏ –≥—ñ–±—ñ—Å–∫—É—Å–∞ –¥–ª—è —Ç—Ä–æ–ø—ñ—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—é", price: 620, emoji: "üå∫", category: "special", badge: null },
            { id: 11, name: "–í–µ—Å—ñ–ª—å–Ω–∞ –±—ñ–ª–∞ –∫–æ–º–ø–æ–∑–∏—Ü—ñ—è", description: "–ï–ª–µ–≥–∞–Ω—Ç–Ω–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –±—ñ–ª–∞ –∫–æ–º–ø–æ–∑–∏—Ü—ñ—è, —ñ–¥–µ–∞–ª—å–Ω–∞ –¥–ª—è –≤–µ—Å—ñ–ª–ª—è", price: 1350, emoji: "ü§ç", category: "arrangement", badge: "–ü—Ä–µ–º—ñ—É–º" },
            { id: 12, name: "–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –¥–æ –î–Ω—è –º–∞—Ç–µ—Ä—ñ", description: "–õ—é–±–æ–≤–Ω–∏–π –±—É–∫–µ—Ç, —â–æ–± –≤–∏—Å–ª–æ–≤–∏—Ç–∏ –≤–¥—è—á–Ω—ñ—Å—Ç—å", price: 950, emoji: "üíù", category: "special", badge: "–ü–æ–¥–∞—Ä—É–Ω–æ–∫" }
        ];

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let state = {
            cart: [],
            customerInfo: { name: '', email: '', phone: '', address: '', message: '', deliveryDate: '' },
            currentSection: 'catalog',
            currentFilter: 'all'
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            initBackgroundFlowers();
            renderProducts();
            renderCart();
            updateCartCount();
            initNavigation();
            initFilters();
        });

        function saveState() {
            localStorage.setItem('hrizantemaState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('hrizantemaState');
            if (savedState) {
                state = JSON.parse(savedState);
                showSection(state.currentSection);
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === state.currentFilter);
                });
            }
        }

        function initBackgroundFlowers() {
            const container = document.getElementById('bgFlowers');
            const flowers = ['üå∏', 'üå∫', 'üå∑', 'üåπ', 'üíÆ', 'üåº', 'üåª', 'üíê'];
            for (let i = 0; i < 15; i++) {
                const flower = document.createElement('span');
                flower.className = 'floating-flower';
                flower.textContent = flowers[Math.floor(Math.random() * flowers.length)];
                flower.style.left = Math.random() * 100 + '%';
                flower.style.top = Math.random() * 100 + '%';
                flower.style.animationDelay = Math.random() * 5 + 's';
                flower.style.fontSize = (1 + Math.random() * 2) + 'rem';
                container.appendChild(flower);
            }
        }

        function initNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => showSection(btn.dataset.section));
            });
        }

        function showSection(sectionId) {
            state.currentSection = sectionId;
            saveState();
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionId);
            });
            document.querySelectorAll('.section').forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });
            if (sectionId === 'cart') renderCart();
        }

        function initFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.currentFilter = btn.dataset.filter;
                    saveState();
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.filter === btn.dataset.filter);
                    });
                    renderProducts(btn.dataset.filter);
                });
            });
        }

        // ============================================
        // PRODUCT RENDERING
        // ============================================
        
        function renderProducts(filter = 'all') {
            const grid = document.getElementById('productsGrid');
            const filteredProducts = filter === 'all' ? products : products.filter(p => p.category === filter);
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.emoji}
                        ${product.badge ? `<span class="product-badge">${product.badge}</span>` : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                        <div class="product-footer">
                            <span class="product-price">${formatPrice(product.price)}</span>
                            <button class="add-to-cart" onclick="addToCart(${product.id})">
                                <span>+</span> –î–æ–¥–∞—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // CART FUNCTIONS
        // ============================================
        
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const existingItem = state.cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                state.cart.push({ ...product, quantity: 1 });
            }
            saveState();
            updateCartCount();
            showToast(`${product.name} –¥–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞!`, 'success');
            const btn = event.target.closest('.add-to-cart');
            btn.classList.add('added');
            btn.innerHTML = '<span>‚úì</span> –î–æ–¥–∞–Ω–æ';
            setTimeout(() => {
                btn.classList.remove('added');
                btn.innerHTML = '<span>+</span> –î–æ–¥–∞—Ç–∏';
            }, 1500);
        }

        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.id !== productId);
            saveState();
            updateCartCount();
            renderCart();
            showToast('–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –∫–æ—à–∏–∫–∞', 'info');
        }

        function updateQuantity(productId, change) {
            const item = state.cart.find(item => item.id === productId);
            if (!item) return;
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
                return;
            }
            saveState();
            updateCartCount();
            renderCart();
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function getCartTotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function renderCart() {
            const container = document.getElementById('cartContent');
            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõí</div>
                        <h3>–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</h3>
                        <p>–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –Ω–∞—à—É —á—É–¥–æ–≤—É –∫–æ–ª–µ–∫—Ü—ñ—é —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –∫–≤—ñ—Ç–∏!</p>
                        <button class="btn btn-primary" onclick="showSection('catalog')" style="margin-top: 20px;">
                            <span>üå∑</span> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–≤—ñ—Ç–∏
                        </button>
                    </div>`;
                return;
            }
            const subtotal = getCartTotal();
            const delivery = subtotal > 1500 ? 0 : 150;
            const total = subtotal + delivery;
            container.innerHTML = `
                <div class="cart-items">
                    ${state.cart.map(item => `
                        <div class="cart-item">
                            <div class="cart-item-image">${item.emoji}</div>
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">${formatPrice(item.price)} –∑–∞ —à—Ç.</div>
                            </div>
                            <div class="cart-item-controls">
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">‚àí</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                                <button class="remove-item" onclick="removeFromCart(${item.id})">üóë</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="cart-summary">
                    <div class="summary-row"><span>–°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤</span><span>${formatPrice(subtotal)}</span></div>
                    <div class="summary-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞ ${subtotal > 1500 ? '(–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –≤—ñ–¥ 1 500 –≥—Ä–Ω!)' : ''}</span><span>${delivery === 0 ? '–ë–ï–ó–ö–û–®–¢–û–í–ù–û' : formatPrice(delivery)}</span></div>
                    <div class="summary-row total"><span>–†–∞–∑–æ–º –¥–æ —Å–ø–ª–∞—Ç–∏</span><span>${formatPrice(total)}</span></div>
                </div>
                <div class="checkout-form">
                    <h3>üìù –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">–ü–æ–≤–Ω–µ —ñ–º'—è *</label>
                            <input type="text" id="customerName" placeholder="–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ" value="${state.customerInfo.name}" onchange="updateCustomerInfo('name', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞ *</label>
                            <input type="email" id="customerEmail" placeholder="ivan@example.com" value="${state.customerInfo.email}" onchange="updateCustomerInfo('email', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É *</label>
                            <input type="tel" id="customerPhone" placeholder="+380 (99) 123-45-67" value="${state.customerInfo.phone}" onchange="updateCustomerInfo('phone', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">–ë–∞–∂–∞–Ω–∞ –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <input type="date" id="deliveryDate" value="${state.customerInfo.deliveryDate}" onchange="updateCustomerInfo('deliveryDate', this.value)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <textarea id="customerAddress" placeholder="–º. –ö–∏—ó–≤, –≤—É–ª. –ö–≤—ñ—Ç–∫–æ–≤–∞, 123, –∫–≤. 45" onchange="updateCustomerInfo('address', this.value)">${state.customerInfo.address}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="customerMessage">–¢–µ–∫—Å—Ç –ª–∏—Å—Ç—ñ–≤–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <textarea id="customerMessage" placeholder="–î–æ–¥–∞–π—Ç–µ –æ—Å–æ–±–∏—Å—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è..." onchange="updateCustomerInfo('message', this.value)">${state.customerInfo.message}</textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="generatePDF()"><span>üìÑ</span> –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ PDF –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
                        <button class="btn btn-success" onclick="openEmailModal()"><span>üìß</span> –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞ –ø–æ—à—Ç—É</button>
                        <button class="btn btn-secondary" onclick="clearCart()"><span>üóë</span> –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫</button>
                    </div>
                </div>`;
        }

        function updateCustomerInfo(field, value) {
            state.customerInfo[field] = value;
            saveState();
        }

        function clearCart() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?')) {
                state.cart = [];
                state.customerInfo = { name: '', email: '', phone: '', address: '', message: '', deliveryDate: '' };
                saveState();
                updateCartCount();
                renderCart();
                showToast('–ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ', 'info');
            }
        }

        // ============================================
        // PDF GENERATION WITH CYRILLIC SUPPORT
        // ============================================
        
        async function generatePDF() {
            if (!validateForm()) return;

            const loadingEl = document.getElementById('fontLoading');
            loadingEl.classList.add('active');

            try {
                // Ensure font is loaded
                await loadCyrillicFont();
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true
                });

                // Register and set Cyrillic font
                if (fontData.loaded && fontData.base64) {
                    const fontFileName = fontData.name + '-Regular.ttf';
                    doc.addFileToVFS(fontFileName, fontData.base64);
                    doc.addFont(fontFileName, fontData.name, 'normal');
                    doc.setFont(fontData.name, 'normal');
                    console.log('Using loaded font:', fontData.name);
                } else {
                    console.warn('Font not loaded, PDF may not display Cyrillic correctly');
                    showToast('–£–≤–∞–≥–∞: —à—Ä–∏—Ñ—Ç –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ, –º–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º', 'info');
                }

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - 2 * margin;

                const subtotal = getCartTotal();
                const delivery = subtotal > 1500 ? 0 : 150;
                const total = subtotal + delivery;
                const orderDate = new Date().toLocaleDateString('uk-UA');
                const orderNumber = 'ORD-' + Date.now().toString().slice(-8);

                // ========== HEADER ==========
                doc.setFillColor(233, 30, 99);
                doc.rect(0, 0, pageWidth, 42, 'F');

                // Store name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.text('–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞', pageWidth / 2, 18, { align: 'center' });
                
                // Tagline
                doc.setFontSize(10);
                doc.text('–ï–ª–µ–≥–∞–Ω—Ç–Ω–∏–π –∫–≤—ñ—Ç–∫–æ–≤–∏–π –±—É—Ç—ñ–∫', pageWidth / 2, 28, { align: 'center' });
                
                // Order confirmation text
                doc.setFontSize(12);
                doc.text('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', pageWidth / 2, 38, { align: 'center' });

                // ========== ORDER INFO ==========
                let y = 52;
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text('–î–∞—Ç–∞: ' + orderDate, margin, y);
                doc.text('–ù–æ–º–µ—Ä: ' + orderNumber, pageWidth - margin, y, { align: 'right' });

                // Divider line
                y += 6;
                doc.setDrawColor(233, 30, 99);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);

                // ========== CUSTOMER INFO SECTION ==========
                y += 10;
                doc.setFillColor(252, 228, 236);
                doc.roundedRect(margin, y - 4, contentWidth, 8, 2, 2, 'F');
                doc.setTextColor(233, 30, 99);
                doc.setFontSize(11);
                doc.text('–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞', margin + 3, y + 2);

                y += 12;
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(9);
                
                const customerData = [
                    { label: "–Ü–º'—è:", value: state.customerInfo.name },
                    { label: "Email:", value: state.customerInfo.email },
                    { label: "–¢–µ–ª–µ—Ñ–æ–Ω:", value: state.customerInfo.phone }
                ];

                customerData.forEach(item => {
                    doc.setTextColor(100, 100, 100);
                    doc.text(item.label, margin, y);
                    doc.setTextColor(40, 40, 40);
                    doc.text(item.value, margin + 25, y);
                    y += 6;
                });

                // Address (may wrap)
                doc.setTextColor(100, 100, 100);
                doc.text("–ê–¥—Ä–µ—Å–∞:", margin, y);
                doc.setTextColor(40, 40, 40);
                const addressLines = doc.splitTextToSize(state.customerInfo.address, contentWidth - 30);
                doc.text(addressLines, margin + 25, y);
                y += 6 * Math.max(addressLines.length, 1);

                // Delivery date
                if (state.customerInfo.deliveryDate) {
                    doc.setTextColor(100, 100, 100);
                    doc.text("–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:", margin, y);
                    doc.setTextColor(40, 40, 40);
                    doc.text(state.customerInfo.deliveryDate, margin + 30, y);
                    y += 6;
                }

                // ========== ITEMS SECTION ==========
                y += 8;
                doc.setFillColor(252, 228, 236);
                doc.roundedRect(margin, y - 4, contentWidth, 8, 2, 2, 'F');
                doc.setTextColor(233, 30, 99);
                doc.setFontSize(11);
                doc.text('–¢–æ–≤–∞—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', margin + 3, y + 2);

                // Table header
                y += 12;
                doc.setFillColor(245, 245, 245);
                doc.rect(margin, y - 4, contentWidth, 8, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(8);
                doc.text('–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è', margin + 2, y + 1);
                doc.text('–ö—ñ–ª.', margin + 90, y + 1);
                doc.text('–¶—ñ–Ω–∞', margin + 105, y + 1);
                doc.text('–°—É–º–∞', margin + 135, y + 1);

                // Table rows
                y += 8;
                doc.setFontSize(9);
                state.cart.forEach((item, index) => {
                    if (index % 2 === 0) {
                        doc.setFillColor(252, 252, 252);
                        doc.rect(margin, y - 4, contentWidth, 8, 'F');
                    }
                    
                    // Truncate long product names
                    let productName = item.name;
                    const maxNameWidth = 85;
                    while (doc.getTextWidth(productName) > maxNameWidth && productName.length > 0) {
                        productName = productName.slice(0, -1);
                    }
                    if (productName !== item.name) {
                        productName = productName.slice(0, -2) + '..';
                    }
                    
                    doc.setTextColor(50, 50, 50);
                    doc.text(productName, margin + 2, y + 1);
                    doc.text(item.quantity.toString(), margin + 93, y + 1);
                    doc.text(formatPriceShort(item.price), margin + 102, y + 1);
                    doc.text(formatPriceShort(item.price * item.quantity), margin + 132, y + 1);
                    y += 8;
                });

                // ========== TOTALS SECTION ==========
                y += 4;
                doc.setDrawColor(200, 200, 200);
                doc.line(margin + 80, y, pageWidth - margin, y);
                
                y += 8;
                doc.setFontSize(9);
                doc.setTextColor(80, 80, 80);
                doc.text('–°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤:', margin + 85, y);
                doc.text(formatPrice(subtotal), margin + 132, y);

                y += 6;
                doc.text('–î–æ—Å—Ç–∞–≤–∫–∞:', margin + 85, y);
                const deliveryText = delivery === 0 ? '–ë–ï–ó–ö–û–®–¢–û–í–ù–û' : formatPrice(delivery);
                doc.text(deliveryText, margin + 132, y);

                // Total box
                y += 10;
                doc.setFillColor(233, 30, 99);
                doc.roundedRect(margin + 80, y - 5, contentWidth - 80, 12, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.text('–†–ê–ó–û–ú:', margin + 85, y + 3);
                doc.text(formatPrice(total), margin + 132, y + 3);

                // ========== GIFT MESSAGE (if present) ==========
                if (state.customerInfo.message && state.customerInfo.message.trim()) {
                    y += 20;
                    doc.setFillColor(252, 228, 236);
                    doc.roundedRect(margin, y - 4, contentWidth, 8, 2, 2, 'F');
                    doc.setTextColor(233, 30, 99);
                    doc.setFontSize(11);
                    doc.text('–¢–µ–∫—Å—Ç –ª–∏—Å—Ç—ñ–≤–∫–∏', margin + 3, y + 2);

                    y += 10;
                    doc.setDrawColor(233, 30, 99);
                    doc.setFillColor(255, 253, 254);
                    const messageLines = doc.splitTextToSize(state.customerInfo.message, contentWidth - 10);
                    const messageBoxHeight = Math.max(messageLines.length * 5 + 8, 15);
                    doc.roundedRect(margin, y - 3, contentWidth, messageBoxHeight, 3, 3, 'FD');
                    
                    doc.setTextColor(80, 80, 80);
                    doc.setFontSize(9);
                    doc.text(messageLines, margin + 5, y + 4);
                }

                // ========== FOOTER ==========
                const footerY = pageHeight - 25;
                
                doc.setDrawColor(233, 30, 99);
                doc.setLineWidth(0.3);
                doc.line(margin, footerY, pageWidth - margin, footerY);

                doc.setTextColor(150, 150, 150);
                doc.setFontSize(8);
                doc.text('–î—è–∫—É—î–º–æ, —â–æ –æ–±—Ä–∞–ª–∏ –∫–≤—ñ—Ç–∫–æ–≤–∏–π –±—É—Ç—ñ–∫ "–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞"!', pageWidth / 2, footerY + 6, { align: 'center' });
                doc.text('–ö–æ–Ω—Ç–∞–∫—Ç–∏: shop@hrizantema.com.ua | +380 (44) 123-45-67', pageWidth / 2, footerY + 11, { align: 'center' });
                doc.text('–º. –ö–∏—ó–≤, –≤—É–ª. –ö–≤—ñ—Ç–∫–æ–≤–∞, 1', pageWidth / 2, footerY + 16, { align: 'center' });

                // Decorative footer line
                doc.setFillColor(233, 30, 99);
                doc.rect(0, pageHeight - 3, pageWidth, 3, 'F');

                // Save the PDF
                const fileName = '–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞_–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è_' + orderNumber + '.pdf';
                doc.save(fileName);
                
                showToast('PDF —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ!', 'success');

            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó PDF: ' + error.message, 'error');
            } finally {
                loadingEl.classList.remove('active');
            }
        }

        // ============================================
        // EMAIL FUNCTIONS
        // ============================================
        
        function openEmailModal() {
            if (!validateForm()) return;
            const modal = document.getElementById('emailModal');
            modal.classList.add('active');
            const preview = document.getElementById('emailOrderPreview');
            const subtotal = getCartTotal();
            const delivery = subtotal > 1500 ? 0 : 150;
            const total = subtotal + delivery;
            preview.innerHTML = `
                <h4 style="margin-bottom: 10px; color: var(--primary-dark);">–ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h4>
                ${state.cart.map(item => `
                    <div class="order-preview-item">
                        <span>${item.emoji} ${item.name} x${item.quantity}</span>
                        <span>${formatPrice(item.price * item.quantity)}</span>
                    </div>
                `).join('')}
                <div class="order-preview-item" style="font-weight: bold; margin-top: 10px;">
                    <span>–†–∞–∑–æ–º</span>
                    <span>${formatPrice(total)}</span>
                </div>`;
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('active');
        }

        function sendEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            const subject = document.getElementById('emailSubject').value;
            if (!recipientEmail) {
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å email –æ—Ç—Ä–∏–º—É–≤–∞—á–∞', 'error');
                return;
            }
            const subtotal = getCartTotal();
            const delivery = subtotal > 1500 ? 0 : 150;
            const total = subtotal + delivery;

            let body = '–ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø –ö–í–Ü–¢–Ü–í - –•–†–ò–ó–ê–ù–¢–ï–ú–ê%0D%0A';
            body += '================================%0D%0A%0D%0A';
            body += '–î–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + new Date().toLocaleDateString('uk-UA') + '%0D%0A';
            body += '–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ORD-' + Date.now().toString().slice(-8) + '%0D%0A%0D%0A';
            body += '–Ü–ù–§–û–†–ú–ê–¶–Ü–Ø –ü–†–û –ö–õ–Ü–Ñ–ù–¢–ê%0D%0A';
            body += '----------------------%0D%0A';
            body += "–Ü–º'—è: " + state.customerInfo.name + '%0D%0A';
            body += 'Email: ' + state.customerInfo.email + '%0D%0A';
            body += '–¢–µ–ª–µ—Ñ–æ–Ω: ' + state.customerInfo.phone + '%0D%0A';
            body += '–ê–¥—Ä–µ—Å–∞: ' + state.customerInfo.address + '%0D%0A';
            if (state.customerInfo.deliveryDate) {
                body += '–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: ' + state.customerInfo.deliveryDate + '%0D%0A';
            }
            body += '%0D%0A';
            body += '–¢–û–í–ê–†–ò –ó–ê–ú–û–í–õ–ï–ù–ù–Ø%0D%0A';
            body += '-----------------%0D%0A';
            state.cart.forEach(item => {
                body += item.name + ' x' + item.quantity + ' - ' + formatPrice(item.price * item.quantity) + '%0D%0A';
            });
            body += '%0D%0A';
            body += '–ü–Ü–î–°–£–ú–û–ö%0D%0A';
            body += '--------%0D%0A';
            body += '–°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤: ' + formatPrice(subtotal) + '%0D%0A';
            body += '–î–æ—Å—Ç–∞–≤–∫–∞: ' + (delivery === 0 ? '–ë–ï–ó–ö–û–®–¢–û–í–ù–û' : formatPrice(delivery)) + '%0D%0A';
            body += '–†–ê–ó–û–ú: ' + formatPrice(total) + '%0D%0A%0D%0A';
            if (state.customerInfo.message) {
                body += '–¢–ï–ö–°–¢ –õ–ò–°–¢–Ü–í–ö–ò%0D%0A';
                body += '--------------%0D%0A';
                body += state.customerInfo.message + '%0D%0A';
            }

            window.location.href = 'mailto:' + recipientEmail + '?subject=' + encodeURIComponent(subject) + '&body=' + body;
            closeEmailModal();
            showToast('–ü–æ—à—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç –≤—ñ–¥–∫—Ä–∏—Ç–æ!', 'success');
        }

        // ============================================
        // VALIDATION
        // ============================================
        
        function validateForm() {
            const { name, email, phone, address } = state.customerInfo;
            if (!name.trim()) {
                showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è", 'error');
                document.getElementById('customerName')?.focus();
                return false;
            }
            if (!email.trim() || !email.includes('@')) {
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π email', 'error');
                document.getElementById('customerEmail')?.focus();
                return false;
            }
            if (!phone.trim()) {
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É', 'error');
                document.getElementById('customerPhone')?.focus();
                return false;
            }
            if (!address.trim()) {
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏', 'error');
                document.getElementById('customerAddress')?.focus();
                return false;
            }
            if (state.cart.length === 0) {
                showToast('–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π', 'error');
                return false;
            }
            return true;
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            toast.innerHTML = '<span>' + icon + '</span> ' + message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                renderProducts(state.currentFilter);
                if (state.currentSection === 'cart') renderCart();
            }, 100);
        });

        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => renderProducts(state.currentFilter), 250);
        });
    </script>
</body>
</html>
